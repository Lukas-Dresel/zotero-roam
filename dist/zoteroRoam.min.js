/* @alixlahuec/zotero-roam 2021-03-06 */

(()=>{window.zoteroRoam={Shortcut:function(e){this.action=e.action;this.template={altKey:false,ctrlKey:false,metaKey:false,shiftKey:false};this.watcher={altKey:false,ctrlKey:false,metaKey:false,shiftKey:false};for(k in e.template){this.template[`${k}`]=e.template[`${k}`];this.watcher[`${k}`]=false}if(Object.keys(this.template).every(e=>this.template[e]===false)){this.template={}}},autoComplete:null,config:{autoComplete:{data:{src:async function(){if(zoteroRoam.data.items.length==0){return[]}else{return zoteroRoam.handlers.simplifyDataArray(zoteroRoam.data.items)}},key:["title","authorsLastNames","year","tagsString"],cache:false,results:e=>{const t=Array.from(new Set(e.map(e=>e.index))).map(t=>{return e.find(e=>e.index===t)});return t}},selector:"#zotero-search-autocomplete",searchEngine:"strict",trigger:{event:["input","focus"]},highlight:true,maxResults:20,sort:(e,t)=>{if(e.value.authors.toLowerCase()<t.value.authors.toLowerCase())return-1;if(e.value.authors.toLowerCase()>t.value.authors.toLowerCase())return 1;return 0},resultsList:{className:"zotero-search-results-list",idName:"zotero-search-results-list",container:e=>{e.classList.add("bp3-menu")}},resultItem:{element:"li",className:"zotero-search_result",idName:"zotero-search_result",content:(t,e)=>{let a=`<span class="bp3-menu-item-label zotero-search-item-key">${t.value.key}</span>`;let o=`<span class="zotero-search-item-metadata"> ${t.value.meta}</span>`;let r=t.key=="title"?t.match:t.value.title;let l=`<span class="zotero-search-item-title" style="font-weight:bold;color:black;display:block;">${r}</span>`;let i="";if(t.value.year){let e=t.key=="year"?t.match:t.value.year;i=`<span class="zotero-search-item-year"> (${e})</span>`}let n="";if(t.value.authors){if(t.key=="authorsLastNames"){n=`<span class="zotero-search-item-authors autoComplete_highlighted">${t.value.authors}</span>`}else{n=`<span class="zotero-search-item-authors">${t.value.authors}</span>`}}let s="";if(t.value.tagsString){let e=t.key=="tagsString"?t.match:t.value.tagsString;s=`<span class="zotero-search-item-tags" style="font-style:italic;color:#c1c0c0;display:block;">${e}</span>`}e.innerHTML=`<a label="${t.value.key}" class="bp3-menu-item bp3-popover-dismiss">
                                            <div class="bp3-text-overflow-ellipsis bp3-fill zotero-search-item-contents">
                                            ${l}
                                            ${n}${i}${o}
                                            ${s}
                                            </div>
                                            ${a}
                                            </a>`}},noResults:(e,t)=>{t(zoteroRoam.autoComplete,e,e.results);const a=document.createElement("li");a.setAttribute("class","no_result");a.setAttribute("tabindex","1");a.innerHTML=`<span style="display: flex; align-items: center; font-weight: 100; color: rgba(0,0,0,.2);">Found No Results for "${e.query}"</span>`;document.querySelector(`#${zoteroRoam.autoComplete.resultsList.idName}`).appendChild(a)},onSelection:e=>{if(zoteroRoam.interface.search.quickCopyToggle.checked){zoteroRoam.interface.search.input.blur();zoteroRoam.interface.search.input.value="@"+e.selection.value.key;zoteroRoam.interface.search.input.select();document.execCommand("copy");zoteroRoam.interface.toggleSearchOverlay("hide")}else{zoteroRoam.interface.search.input.blur();zoteroRoam.interface.renderSelectedItem(e)}}},requests:{},shortcuts:[],userSettings:{}},data:{items:[],collections:[]},funcmap:{DEFAULT:"zoteroRoam.formatting.getItemMetadata"},typemap:{artwork:"Illustration",audioRecording:"Recording",bill:"Legislation",blogPost:"Blog post",book:"Book",bookSection:"Chapter",case:"Legal case",computerProgram:"Data",conferencePaper:"Conference paper",document:"Document",email:"Letter",encyclopediaArticle:"Encyclopaedia article",film:"Film",forumPost:"Forum post",hearing:"Hearing",instantMessage:"Instant message",interview:"Interview",journalArticle:"Article",letter:"Letter",magazineArticle:"Magazine article",manuscript:"Manuscript",map:"Image",newspaperArticle:"Newspaper article",patent:"Patent",podcast:"Podcast",presentation:"Presentation",radioBroadcast:"Radio broadcast",report:"Report",statute:"Legislation",thesis:"Thesis",tvBroadcast:"TV broadcast",videoRecording:"Recording",webpage:"Webpage"},addAutoCompleteCSS(){let e=document.createElement("style");e.textContent=`ul#zotero-search-results-list::before{content:attr(aria-label);}
                                            li.autoComplete_selected{background-color:#e7f3f7;}
                                            span.autoComplete_highlighted{color:#146cb7;}
                                            .selected-item-header, .selected-item-body{display:flex;justify-content:space-around;}
                                            .item-basic-metadata, .item-additional-metadata{flex: 0 1 60%;}
                                            .item-citekey, .item-actions{flex:0 1 30%;}
                                            .item-citekey{margin:10px 0px;}
                                            .item-citekey input.bp3-input[readonly]{box-shadow:none;font-weight:bold;}`;document.head.append(e)}};var e=document.createElement("script");e.src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@8.3.2/dist/js/autoComplete.js";e.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(e)})();()=>{zoteroRoam.utils={addBlock(e,t,a=0){window.roamAlphaAPI.createBlock({location:{"parent-uid":e,order:a},block:{string:t}})},executeFunctionByName(e,t){var a=Array.prototype.slice.call(arguments,2);var o=e.split(".");var r=o.pop();for(var l=0;l<o.length;l++){t=t[o[l]]}return t[r].apply(t,a)},formatBib(e){let t=e.match('csl-entry">(.+)</div>')[1];let a=document.createElement("textarea");a.innerHTML=t;let o=a.innerText;o=o.replaceAll(/<\/?i>/g,"__");return o},formatItemNotes(e){return e.map(e=>{let t=e.data.note.split("\n");return t.map(e=>zoteroRoam.utils.parseNoteBlock(e)).filter(e=>e.trim())})},getTopBlockData(e){let t=window.roamAlphaAPI.q("[:find ?bUID ?bText :in $ ?pUID :where[?b :block/uid ?bUID][?b :block/string ?bText][?b :block/order 0][?p :block/children ?b][?p :block/uid ?pUID]]",e);if(typeof t==="undefined"||t==null||t.length==0){return false}else{try{let e={uid:t[0][0],text:t[0][1]};return e}catch(e){console.error(e)}}},lookForPage(e){let t=null;let a=window.roamAlphaAPI.q("[:find ?uid :in $ ?title :where[?p :block/uid ?uid][?p :node/title ?title]]",e);if(a.length>0){t={present:true,uid:a[0][0]}}else{t={present:false}}return t},makeDNP(e){if(e.constructor!==Date){e=new Date(item.data.dateAdded)}let t=["January","February","March","April","May","June","July","August","September","October","November","December"];return`${t[e.getMonth()]} ${makeOrdinal(e.getDate())}, ${e.getFullYear()}`},makeOrdinal(e){let t=e%10;if(t==1&e!=11){return e+"st"}else if(t==2&e!=12){return e+"nd"}else if(t==3&e!=13){return e+"rd"}else{return e+"th"}},makePDFLinks(e){if(e.length>0){return e.map(e=>e.data.linkMode=="linked_file"?`[${e.data.title}](zotero://open-pdf/library/items/${e.data.key})`:`[${e.data.title}](${e.data.url})`)}else{return false}},parseNoteBlock(e){let t=e;let a={"<p>":"","</p>":"","<blockquote>":"> ","</blockquote>":"","<strong>":"**","</strong>":"**","<em>":"__","</em>":"__","<b>":"**","</b>":"**","<br />":"\n"};for(prop in a){t=t.replaceAll(`${prop}`,`${a[prop]}`)}let o=/<a href="(.+)">(.+)<\/a>/g;t=t.replaceAll(o,`[$2]($1)`);return t},renderBP3Tag(e,t=""){return`<span class="bp3-tag bp3-minimal ${t}" style="margin:5px;">${e}</span>`},renderHTMLBlockObject(e){let t="";if(typeof e.string==="undefined"){alert("Some of the input was passed as an Object but without a string property. See console for more details");console.log(e);throw new Error("All blocks passed as an Object must have a string property")}else{t=t+`<li>${e.string}`;if(typeof e.children!=="undefined"){if(e.children.length>0){t=t+zoteroRoam.utils.renderHTMLMetadataArray(e.children)}}t=t+` </li>`}return t},renderHTMLMetadataArray(e){let t=`<ul>`;e.forEach(e=>{if(e.constructor===Object){t=t+zoteroRoam.utils.renderHTMLBlockObject(e)}else if(e.constructor===String){t=t+`<li>${e} </li>`}else{alert("Some of the input was of the wrong type. See the console for more details");console.log(e);throw new Error("All array items should be of type String or Object")}});t=t+`</ul>`;return t},renderPageReference(e,t){return`<span data-link-title="${e}" data-link-uid="${t}">
            <span tabindex="-1" class="rm-page-ref rm-page-ref--link">${e}</span></span>`},renderPageTag(e){return`<span tabindex="-1" data-tag="${e}" class="rm-page-ref rm-page-ref--tag">#${e}</span>`},sleep(t){return new Promise(e=>setTimeout(e,t))}}};()=>{zoteroRoam.handlers={async addBlockObject(t,a){if(typeof a.string==="undefined"){console.log(a);throw new Error("All blocks passed as an Object must have a string property")}else{zoteroRoam.utils.addBlock(uid=t,blockString=a.string,order=0);if(typeof a.children!=="undefined"){let e=await zoteroRoam.handlers.waitForBlockUID(t,a.string);for(j=a.children.length-1;j>=0;j--){if(a.children[j].constructor===Object){await zoteroRoam.handlers.addBlockObject(e,a.children[j])}else if(a.children[j].constructor===String){zoteroRoam.utils.addBlock(uid=e,blockString=a.children[j],order=0)}else{throw new Error("All children array items should be of type String or Object")}}}}},async addItemData(e){try{let t=e.parentElement.dataset.linkTitle.replace("@","");let a=e.parentElement.dataset.linkUid;let o=zoteroRoam.data.items.find(e=>{return e.key==t});if(o){let e=await zoteroRoam.handlers.formatData(o);if(e.length>0){await zoteroRoam.handlers.addMetadataArray(page_uid=a,arr=e)}}}catch(e){console.error(e)}},async addMetadataArray(e,t){if(t.length>0){for(k=t.length-1;k>=0;k--){if(t[k].constructor===Object){await zoteroRoam.handlers.addBlockObject(e,t[k])}else if(t[k].constructor===String){zoteroRoam.utils.addBlock(uid=e,blockString=t[k],order=0)}else{console.log(t[k]);throw new Error("All array items should be of type String or Object")}}}else{console.log("The metadata array was empty ; nothing was done.")}},async addSearchResult(a,e){let t=a.replace("@","");let o=zoteroRoam.data.items.find(function(e){return e.key==t});let r=await zoteroRoam.handlers.formatData(o);if(o&&r.length>0){if(e){await zoteroRoam.handlers.addMetadataArray(page_uid=e,arr=r)}else{window.roamAlphaAPI.createPage({page:{title:a}});let e=await zoteroRoam.handlers.waitForPageUID(a);if(e!=null){await zoteroRoam.handlers.addMetadataArray(page_uid=e,arr=r);let t=zoteroRoam.utils.lookForPage(a);if(t.present){let e=window.roamAlphaAPI.q("[:find (count ?chld) :in $ ?uid :where[?p :block/uid ?uid][?p :block/children ?chld]]",t.uid)[0][0];alert(`Page was successfully added to the graph.
                            It currently has ${e} child blocks.`)}else{alert(`Something went wrong in creating the page`)}}else{console.log(e);throw new Error("There was a problem in obtaining the page's UID.")}}}else{console.log(o);console.log(r);throw new Error("Something went wrong when attempting to format the item's data.")}},extractCitekeys(e){return e.map(e=>{if(typeof e.data.extra!=="undefined"){if(e.data.extra.includes("Citation Key: ")){e.key=e.data.extra.match("Citation Key: (.+)")[1]}}return e})},async fetchData(d,u,a){let e=`https://api.zotero.org/${u}?${a}`;try{let t=await fetch(e,{method:"GET",headers:{"Zotero-API-Version":3,"Zotero-API-Key":d}});if(t.status=="ok"){let r=t.headers.get("Total-Results");let l=new URLSearchParams(a);let e=l.has("start")?Number(l.get("start")):0;let n=l.has("limit")?Number(l.get("limit")):100;let s=await t.json();let c=e+s.length;if(c<r){let e=Math.ceil((r-c)/n);let t=[];for(i=1;i<=e;i++){let e=c+n*(i-1);l.set("start",e);l.set("limit",n);t.push(fetch(`https://api.zotero.org/${u}?${l.toString()}`,{method:"GET",headers:{"Zotero-API-Version":3,"Zotero-API-Key":d}}))}let a=await Promise.all(t);let o=await Promise.all(a.map(e=>{return e.json()}));o=o.flat(1);s.push(...o)}}}catch(e){console.error(e)}finally{return{data:results}}},async formatData(e){let t=[];let a=e.data.itemType;let o=zoteroRoam.funcmap.DEFAULT;if(zoteroRoam.config.userSettings.funcmap){o=zoteroRoam.config.userSettings.funcmap[`${a}`]||zoteroRoam.config.userSettings.funcmap["DEFAULT"]||o}try{t=await zoteroRoam.utils.executeFunctionByName(o,window,e);return t}catch(e){console.error(e);console.log(`There was a problem when formatting the item with function ${o}`);return[]}},setupUserRequests(){if(!zoteroRoam.config.userSettings.dataRequests){throw new Error("At least one data request object needs to be specified in order to use the extension. Read through the docs for basic setup examples.")}else{let e=zoteroRoam.config.userSettings.dataRequests;e=e.constructor===Array?e:[e];let a=e.find(e=>e.apikey!==undefined)["apikey"];let o=e.find(e=>e.params!==undefined)["params"];e=e.map((e,t)=>{e.name=e.name||`${t}`;e.apikey=e.apikey||a;e.params=e.params||o;return e});zoteroRoam.config.requests=e}},async requestData(r){try{let a=[];let o=[];r.forEach(e=>{let t=e.dataURI.match(/(users|groups)\/(.+)\//g);a.push(zoteroRoam.handlers.fetchData(apiKey=e.apikey,dataURI=e.dataURI,params=e.params));o.push(fetch(`https://api.zotero.org/${t}/collections`),{method:"GET",headers:{"Zotero-API-Version":3,"Zotero-API-Key":e.apikey}})});let e=await Promise.all(a);e=e.map((e,t)=>e.data.map(e=>{e.requestLabel=r[t].name;e.requestIndex=t;return e})).flat(1);e=zoteroRoam.handlers.extractCitekeys(e);let t=await Promise.all(o);t=await Promise.all(o.map(e=>{return e.json()}));t=t.flat(1);return{success:true,data:{items:e,collections:t}}}catch(e){console.error(e);return{success:false}}},async requestItemBib(e,t){let a=e.library.type=="user"?"users":"groups";let o=zoteroRoam.config.requests[`${e.requestIndex}`].apikey;let r=await fetch(`${a}/${e.library.id}/items/${e.data.key}?include=bib&style=${t}`,{method:"GET",headers:{"Zotero-API-Version":3,"Zotero-API-Key":o}});let l=await r.json();let i=l.bib;return i},async requestItemChildren(e){let t=zoteroRoam.config.requests[`${e.requestIndex}`].apikey;let a=await fetch(`${e.links.self.href}/children`,{method:"GET",headers:{"Zotero-API-Version":3,"Zotero-API-Key":t}});let o=await a.json();return o},simplifyDataArray(e){let t=e.filter(e=>{return e.data.itemType!="attachment"&&e.data.itemType!="note"});t=t.map(e=>{let t={key:e.key,title:`${e.data.title||""}`,abstract:`${e.data.abstractNote||""}`,authors:`${e.meta.creatorSummary||""}`,year:`${e.meta.parsedDate?new Date(e.meta.parsedDate).getUTCFullYear().toString():""}`,meta:"",tags:e.data.tags.map(e=>e.tag),authorsFull:e.data.creators.map(e=>{return e.name?e.name:[e.firstName,e.lastName].filter(Boolean).join(" ")}),authorsRoles:e.data.creators.map(e=>e.creatorType),authorsLastNames:e.data.creators.map(e=>e.lastName),tagsString:e.data.tags.map(e=>`#${e.tag}`).join(", ")};let a=[e.data.publicationTitle,e.data.university,e.data.bookTitle].filter(Boolean);if(a.length>0){t.meta=t.meta+`, ${a[0]}`}if(e.data.publisher){t.meta=t.meta+`, ${e.data.publisher}`;if(e.data.place){t.meta=t.meta+`: ${e.data.place}`}}if(e.data.volume){t.meta=t.meta+`, ${e.data.volume}`;if(e.data.issue){t.meta=t.meta+`(${e.data.issue})`}}t.meta=e.data.pages?t.meta+`, ${e.data.pages}.`:".";return t});return t},async waitForBlockUID(e,t){let a=null;let o=false;let r=0;try{do{a=zoteroRoam.utils.getTopBlockData(e);if(typeof a.text!=="undefined"&&a.text==t){o=true;return a.uid}else{r=r+1;await zoteroRoam.utils.sleep(75)}}while(r<50&&!o);console.log(a);throw new Error("The top block couldn't be matched")}catch(e){console.error(e)}},async waitForPageUID(t){let a=false;let o=0;do{let e=lookForPage(t);if(e.present==true){a=true;return e.uid}else{o+=1;await zoteroRoam.utils.sleep(75)}}while(o<50&&!a);throw new Error(`The page with title "${t}" couldn\'t be found`)}}};()=>{zoteroRoam.interface={icon:null,portal:{div:null,id:"zotero-data-importer-portal"},contextMenu:{div:null,class:"zotero-context-menu",overlay:{div:null,class:"zotero-context-overlay"},options:{list:[],class:"zotero-context-menu-option",labels:["Import Zotero data to page"]},visible:false,targetElement:null,position({top:e,left:t}){zoteroRoam.interface.contextMenu.style.left=`${t}px`;zoteroRoam.interface.contextMenu.style.top=`${e}px`;zoteroRoam.interface.toggleContextOverlay("contextMenu","show")}},iconContextMenu:{div:null,class:"zotero-icon-context-menu",overlay:{div:null,class:"zotero-icon-context-overlay"},options:{list:[],class:"zotero-icon-context-menu-option",labels:["Update Zotero data","Search in dataset..."]},visible:false,position({top:e,left:t}){zoteroRoam.interface.iconContextMenu.style.left=t>=.9*window.innerWidth?`calc(${t}px - 7%)`:`${t}px`;zoteroRoam.interface.iconContextMenu.style.top=`calc(${e}px + 3%)`;zoteroRoam.interface.toggleContextOverlay("iconContextMenu","show")}},search:{div:null,overlay:null,input:null,selectedItemDiv:null,quickCopyToggle:null,closeButton:null,updateButton:null,visible:false},create(){zoteroRoam.interface.icon=zoteroRoam.interface.createIcon(id="zotero-data-icon");zoteroRoam.interface.portal.div=zoteroRoam.interface.createPortal(id=zoteroRoam.interface.portal.id);zoteroRoam.interface.createContextMenu(elementKey="contextMenu");zoteroRoam.interface.createContextMenu(elementKey="iconContextMenu");zoteroRoam.interface.createSearchOverlay()},setup(){zoteroRoam.interface.icon.onclick=zoteroRoam.extension.toggle();zoteroRoam.interface.setupContextMenus(["contextMenu","iconContextMenu"]);zoteroRoam.interface.icon.addEventListener("contextmenu",addListenerToZoteroIcon);zoteroRoam.interface.search.updateButton.addEventListener("click",zoteroRoam.extension.update);zoteroRoam.interface.search.closeButton.addEventListener("click",function(){zoteroRoam.interface.toggleSearchOverlay("hide")});zoteroRoam.interface.search.input.addEventListener("rendered",zoteroRoam.interface.renderNbResults)},createIcon(e){try{document.getElementById(e).remove()}catch(e){}var t=document.createElement("span");t.classList.add("bp3-popover-wrapper");t.setAttribute("style","margin-left: 4px;");t.innerHTML=`<span class="bp3-popover-target"><span id="${e}" status="off" class="bp3-button bp3-icon-manual bp3-minimal bp3-small"></span>`;document.querySelector(".rm-topbar").appendChild(t);return t},createPortal(e){try{document.getElementById(e).remove()}catch(e){}var t=document.createElement("div");t.classList.add("bp3-portal");t.id=e;document.getElementById("app").appendChild(t);return t},createContextMenu(e){let t=zoteroRoam.interface[`${e}`];try{document.querySelector(`.${t.overlay.class}`).remove()}catch(e){}let a=`z-index:25;`;let o=`width: auto; position: fixed;z-index:25;`;let r=t.options.labels.map(e=>`<li class="${t.options.class}"><a class="bp3-menu-item bp3-popover-dismiss"><div class="bp3-fill bp3-text-overflow-ellipsis">${e}</div></a></li>`).join("");var l=document.createElement("div");l.classList.add("bp3-overlay");l.classList.add("bp3-overlay-open");l.classList.add(`${t.overlay.class}`);l.style=`display:none;`;l.innerHTML=`<div class="bp3-overlay-backdrop bp3-popover-backdrop bp3-popover-appear-done bp3-popover-enter-done" style="${a}"></div>
                                    <div class="bp3-transition-container bp3-popover-appear-done bp3-popover-enter-done ${t.class}" style="${o}">
                                        <div class="bp3-popover bp3-minimal">
                                            <div class="bp3-popover-content">
                                                <div>
                                                    <ul class="bp3-menu bp3-text-small">
                                                        ${r}
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>`;zoteroRoam.interface.portal.div.appendChild(l);zoteroRoam.interface[`${e}`].overlay.div=document.querySelector(`.${zoteroRoam.interface[`${e}`].overlay.class}`);zoteroRoam.interface[`${e}`].div=document.querySelector(`.${zoteroRoam.interface[`${e}`].class}`);zoteroRoam.interface[`${e}`].options.list=document.querySelectorAll(`.${zoteroRoam.interface[`${e}`].options.class}`)},createSearchOverlay(){try{document.querySelector(".zotero-search-overlay").remove()}catch(e){}let e=document.createElement("div");e.classList.add("bp3-overlay");e.classList.add("bp3-overlay-open");e.classList.add("bp3-overlay-scroll-container");e.classList.add("zotero-search-overlay");e.style="display:none;";let t=document.createElement("div");t.classList.add("bp3-overlay-backdrop");t.classList.add("bp3-overlay-appear-done");t.classList.add("bp3-overlay-enter-done");t.classList.add("zotero-search-backdrop");t.tabIndex="0";let a=document.createElement("div");a.classList.add("bp3-dialog-container");a.classList.add("bp3-overlay-content");a.classList.add("bp3-overlay-appear-done");a.classList.add("bp3-overlay-enter-done");a.tabIndex="0";let o=document.createElement("div");o.classList.add("bp3-dialog");o.style="width:60%;align-self:baseline;";let r=document.createElement("div");r.classList.add("bp3-dialog-header");let l=document.createElement("div");l.classList.add("bp3-dialog-body");let i=document.createElement("div");i.classList.add("bp3-dialog-footer");r.innerHTML=`<label class="bp3-control bp3-switch" style="margin-bottom:0px;flex: 1 1 auto;">
                                            <input id="zotero-quick-copy-mode" type="checkbox"><span class="bp3-control-indicator"></span>Quick Copy</label>
                                            <span style="font-style:italic;">Press Esc or Alt-Q to exit</span>
                                            <button type="button" aria-label="Close" class="zotero-search-close bp3-button bp3-minimal bp3-dialog-close-button">
                                            <span icon="small-cross" class="bp3-icon bp3-icon-small-cross"><svg data-icon="small-cross" width="20" height="20" viewBox="0 0 20 20"><desc>small-cross</desc><path d="M11.41 10l3.29-3.29c.19-.18.3-.43.3-.71a1.003 1.003 0 00-1.71-.71L10 8.59l-3.29-3.3a1.003 1.003 0 00-1.42 1.42L8.59 10 5.3 13.29c-.19.18-.3.43-.3.71a1.003 1.003 0 001.71.71l3.29-3.3 3.29 3.29c.18.19.43.3.71.3a1.003 1.003 0 00.71-1.71L11.41 10z" fill-rule="evenodd"></path></svg></span></button>`;let n=document.createElement("p");n.innerHTML=`<strong>Enter text below to look for items* in your loaded Zotero dataset.</strong>
                            <br>(* searchable fields are : title, year, authors, tags. A more fully-featured search will be available down the road)`;l.appendChild(n);let s=document.createElement("input");s.id="zotero-search-autocomplete";s.tabIndex="1";s.type="text";s.classList.add("bp3-input");s.classList.add("bp3-fill");s.style="margin-bottom:20px;";l.appendChild(s);let c=document.createElement("div");c.id="zotero-search-selected-item";c.classList.add("bp3-card");c.style="width:95%;margin:0 auto;display:none;";let d=document.createElement("div");d.classList.add("selected-item-header");let u=document.createElement("div");u.classList.add("selected-item-body");c.appendChild(d);c.appendChild(u);l.appendChild(c);i.innerHTML=`<div class="bp3-dialog-footer-actions">
                                            <span class="bp3-popover2-target" tabindex="0">
                                            <button type="button" class="zotero-update-data bp3-button">
                                            <span class="bp3-button-text">Update Zotero data</span>
                                            </button></span></div>`;o.appendChild(r);o.appendChild(l);o.appendChild(i);a.appendChild(o);e.appendChild(t);e.appendChild(a);zoteroRoam.interface.portal.div.appendChild(e);zoteroRoam.interface.search.overlay=document.querySelector(".zotero-search-overlay");zoteroRoam.interface.search.input=document.querySelector("#zotero-search-autocomplete");zoteroRoam.interface.search.selectedItemDiv=document.querySelector("#zotero-search-selected-item");zoteroRoam.interface.search.quickCopyToggle=document.querySelector("#zotero-quick-copy-mode");zoteroRoam.interface.search.closeButton=document.querySelector("button.zotero-search-close");zoteroRoam.interface.search.updateButton=document.querySelector("button.zotero-update-data")},setupContextMenus(t){window.addEventListener("click",e=>{t.forEach(e=>{if(zoteroRoam.interface[`${e}`].visible){zoteroRoam.interface.toggleContextOverlay(e,command="hide")}})});t.forEach(a=>{zoteroRoam.interface[`${a}`].options.list.forEach((e,t)=>{switch(zoteroRoam.interface[`${a}`].options.labels[t]){case"Import Zotero data to page":e.addEventListener("click",function(){zoteroRoam.handlers.addItemData(zoteroRoam.interface.contextMenu.targetElement)});break;case"Update Zotero data":e.addEventListener("click",zoteroRoam.extension.update);break;case"Search in dataset...":e.addEventListener("click",function(){zoteroRoam.interface.toggleSearchOverlay("show")})}})})},toggleContextOverlay(e,t){zoteroRoam.interface[`${e}`].overlay.div.style.display=t=="show"?"block":"none";zoteroRoam.interface[`${e}`].visible=t=="show"?true:false},toggleSearchOverlay(e){zoteroRoam.interface.search.overlay.style.display=e==="show"?"block":"none";if(e=="show"){zoteroRoam.interface.search.input.focus();zoteroRoam.interface.search.visible=true}else{zoteroRoam.interface.clearSelectedItem();zoteroRoam.interface.search.input.value="";zoteroRoam.interface.search.visible=false}},popContextOverlay(e,t){e.preventDefault();const a={left:e.pageX,top:e.pageY};zoteroRoam.interface[`${t}`].position(a);if(t=="contextMenu"){zoteroRoam.interface.contextMenu.targetElement=e.target}return false},renderNbResults(e){let t="";if(e.detail.results.length>0){t=`Showing ${e.detail.results.length} out of ${e.detail.matches.length} results`}document.querySelector("#zotero-search-results-list").setAttribute("aria-label",t)},renderSelectedItem(e){let t="@"+e.selection.value.key;let a=e.selection.value.year?" ("+e.selection.value.year+")":"";let o=e.selection.value.authorsFull;let r=e.selection.value.authorsRoles;let l="";if(o.length>0){for(i=0;i<o.length;i++){let e=zoteroRoam.utils.lookForPage(title=o[i]);let t=e.present==true?zoteroRoam.utils.renderPageReference(title=o[i],uid=e.uid):zoteroRoam.utils.renderBP3Tag(string=o[i],modifier="bp3-intent-primary bp3-round");let a=r[i]&&r[i]!="author"?` (${r[i]})`:"";l=l+t+a;if(i<o.length-2){l=l+", "}else if(i==o.length-2){l=l+" & "}}}let n=e.selection.value.tags;let s="";if(n.length>0){for(i=0;i<n.length;i++){let e=zoteroRoam.utils.lookForPage(title=n[i]);let t=e.present==true?zoteroRoam.utils.renderPageTag(title=n[i]):zoteroRoam.utils.renderBP3Tag(string=n[i]);s=s+t+" "}}let c=zoteroRoam.utils.lookForPage(t);let d=document.querySelector(".selected-item-header");d.innerHTML=`<div class="item-basic-metadata">
                                        <h4 class="item-title">${e.selection.value.title}${a}</h4>
                                        <p class="item-metadata-string">${l}${e.selection.value.meta}</p>
                                        </div>
                                    <div class="item-citekey">
                                        <div class="bp3-control-group">
                                            <div class="bp3-input-group bp3-fill"><input type="text" class="bp3-input" value="${t}" readonly></div>
                                            <button type="button" class="bp3-button item-copy-citekey"><span icon="clipboard" class="bp3-icon bp3-icon-clipboard"></span></button>
                                        </div>
                                    </div>`;let u=document.querySelector(".selected-item-body");let p=c.uid?c.uid:"";let m=c.present==true?"tick":"cross";let f=c.present==true?"success":"danger";let h=c.present==true?`Page already exists in the graph`:"Page doesn't exist in the graph";u.innerHTML=`<div class="item-additional-metadata">
                                    <p class="item-abstract">${e.selection.value.abstract}</p>
                                    <p class="item-tags">${s}</p>
                                </div>
                                <div class="item-actions">
                                    <div style="padding:5px 10px;font-style:italic;"><span class="bp3-icon-${m} bp3-icon bp3-intent-${f}"></span><span> ${h}</span></div>
                                    <div class="bp3-button-group bp3-minimal bp3-vertical bp3-align-left">
                                    <button type="button" class="bp3-button item-add-metadata">
                                        <span icon="add" class="bp3-icon bp3-icon-add bp3-intent-primary"></span>
                                        <span class="bp3-button-text">Import metadata</span>
                                    </button>
                                    </div>
                                </div>`;document.querySelector("button.item-add-metadata").addEventListener("click",function(){zoteroRoam.handlers.addSearchResult(t,p)});document.querySelector("button.item-copy-citekey").addEventListener("click",function(){document.querySelector(".item-citekey input").select();document.execCommand("copy");document.querySelector(".item-citekey input").blur()});zoteroRoam.interface.search.selectedItemDiv.style.display="block"},clearSelectedItem(){zoteroRoam.interface.search.selectedItemDiv.children.forEach(e=>{e.innerHTML=``});zoteroRoam.interface.search.selectedItemDiv.style.display="none"}}};()=>{zoteroRoam.pageRefs={addContextMenuListener(){var e=document.querySelectorAll(".ref-citekey");for(var t=0;t<e.length;t++){var a=e[t];if(!a.dataset.zoteroBib){if(zoteroRoam.data.items.find(e=>e.key==a.dataset.linkTitle.replace("@",""))){a.dataset.zoteroBib="inLibrary"}else{a.dataset.zoteroBib="notFound"}}if(a.dataset.zoteroBib=="inLibrary"){a.querySelector(".rm-page-ref").addEventListener("contextmenu",handler=function(e){zoteroRoam.interface.popContextOverlay(e,elementKey="contextMenu")})}else if(a.dataset.zoteroBib=="notFound"){console.log("This citekey was checked against the contents of ZoteroData but didn't match any item. Make sure your citekeys are pinned.")}}},checkReferences(){let t=false;setTimeout(function(){do{let e=document.getElementsByClassName("rm-page-ref");t=zoteroRoam.pageRefs.identifyCitekeys(e)}while(t==true)},300);zoteroRoam.pageRefs.checkCitekeys(update=true);zoteroRoam.pageRefs.addContextMenuListener()},identifyCitekeys(t){let a=false;for(i=0;i<t.length;i++){let e=t[i].parentElement;if(typeof e.dataset.linkTitle==="undefined"){continue}else{if(e.dataset.linkTitle.startsWith("@")){if(e.classList.contains("ref-citekey")){a=false}else{e.classList.add("ref-citekey");a=true}}}}return a},checkCitekeys(e="false"){let t=document.querySelectorAll(".ref-citekey");let a=0;let o=0;t.forEach(t=>{if(t.dataset.zoteroBib){if(e==true){if(t.dataset.zoteroBib=="notFound"){if(zoteroRoam.data.items.find(e=>e.key==t.dataset.linkTitle.replace("@",""))){t.dataset.zoteroBib="inLibrary";a=a+1}else{o=o+1}}}}else{t.dataset.zoteroBib=zoteroRoam.data.items.find(e=>e.key==t.dataset.linkTitle.replace("@",""))?"inLibrary":"notFound";switch(t.dataset.zoteroBib){case"inLibrary":a+=1;break;case"notFound":o+=1}}});if(a>0|o>0){console.log(`New matched citekeys: ${a}, New unmatched citekeys: ${o}`)}}}};()=>{zoteroRoam.formatting={getCreators(e){return e.data.creators.map(e=>{let t=e.name?`[[${e.name}]]`:`[[${[e.firstName,e.lastName].filter(Boolean).join(" ")}]]`;if(e.creatorType!="author"){t=t+" ("+e.creatorType+")"}return t}).join(", ")},async getItemBib(e,t="apa"){let a=e.bib?e.bib:await zoteroRoam.handlers.requestItemBib(e,t);return zoteroRoam.utils.formatBib(a)},async getItemChildren(t){let e={pdfItems:false,notes:false};let a=[];if(t.meta.numChildren>0){let e=zoteroRoam.data.items.filter(e=>e.data.parentItem==t.data.key&e.library.id==t.library.id);if(e.length==0){let e=await zoteroRoam.handlers.requestItemChildren(t);a=e||[]}else{a=e}}e.pdfItems=zoteroRoam.utils.makePDFLinks(a.filter(e=>e.data.contentType=="application/pdf"));e.notes=zoteroRoam.utils.formatItemNotes(a.filter(e=>e.data.itemType=="note"));return e},getItemCollections(a){if(a.data.collections.length>0){return a.data.collections.map(t=>zoteroRoam.data.collections.find(e=>e.key==t&&e.library.id==a.library.id))}else{return false}},getItemType(e){let t=zoteroRoam.typemap[e.data.itemType]||e.data.itemType;if(zoteroRoam.config.userSettings.typemap){t=zoteroRoam.config.userSettings.typemap[e.data.itemType]||t}return t},getLocalLink(e,t="Local library"){return`[${t}](zotero://select/library/items/${e.data.key})`},getWebLink(e,t="Web library"){let a=(e.library.type="user")?"users":"groups";return`[${t}](https://www.zotero.org/${a}/${e.library.id}/items/${e.data.key})`},getTags(e){return e.data.tags.map(e=>"#[["+e.tag+"]]").join(", ")},getItemMetadata(e){let t=[];if(e.data.title){t.push(`Title:: ${e.data.title}`)}if(e.data.creators.length>0){t.push(`Author(s):: ${getCreators(e)}`)}if(e.data.abstractNote){t.push(`Abstract:: ${e.data.abstractNote}`)}if(e.data.itemType){t.push(`Type:: [[${getItemType(e)}]]`)}t.push(`Publication:: ${e.data.publicationTitle||e.data.bookTitle||""}`);if(e.data.url){t.push(`URL : ${e.data.url}`)}if(e.data.dateAdded){t.push(`Date Added:: [[${makeDNP(e.data.dateAdded)}]]`)}t.push(`Zotero links:: ${getLocalLink(e)}, ${getWebLink(e)}`);if(e.data.tags.length>0){t.push(`Tags:: ${getTags(e)}`)}return t}}};()=>{zoteroRoam.shortcuts={actions:{closeSearchPanel:{defaultShortcut:{Escape:true},execute(){if(zoteroRoam.interface.search.visible){zoteroRoam.interface.toggleSearchOverlay("hide")}}},toggleSearchPanel:{defaultShortcut:{altKey:true,q:true},execute(){let e=zoteroRoam.interface.search.visible?"hide":"show";zoteroRoam.interface.toggleSearchOverlay(e)}},toggleQuickCopy:{defaultShortcut:[],execute(){let e=zoteroRoam.interface.search.quickCopyToggle.checked?false:true;zoteroRoam.interface.search.quickCopyToggle.checked=e}},importMetadata:{defaultShortcut:[],execute(){let e=document.querySelector("button.item-add-metadata");if(e!==null){e.click()}}}},setup(){let t={};for(action in zoteroRoam.shortcuts.actions){let{[action]:e=action.defaultShortcut}=zoteroRoam.config.userSettings.shortcuts;t[action]=e}let a=[];for(k in t){if(t[k].constructor===Object){a.push({action:k,template:t[k]})}else if(t[k].constructor===Array){t[k].forEach(e=>{a.push({action:k,template:e})})}}a.forEach(e=>{zoteroRoam.config.shortcuts.push(new zoteroRoam.Shortcut(e))})},verify(a){let e=a.key;let o=a.type=="keydown"?true:false;let r=["altKey","ctrlKey","metaKey","shiftKey"];zoteroRoam.config.shortcuts.forEach(t=>{r.forEach(e=>{t.watcher[`${e}`]=a[`${e}`]});if(t.template.hasOwnProperty(e)){t.watcher[`${e}`]=o}});zoteroRoam.config.shortcuts.forEach(e=>{if(JSON.stringify(e.watcher)===JSON.stringify(e.template)){zoteroRoam.shortcuts.actions[`${e.action}`].execute()}})}}};()=>{if(typeof window.zoteroRoam==="undefined"&&typeof window.zoteroRoam_settings!=="undefined"){zoteroRoam.interface.create();zoteroRoam.interface.setup();zoteroRoam.addAutoCompleteCSS();zoteroRoam.config.userSettings=window.zoteroRoam_settings;zoteroRoam.shortcuts.setup();zoteroRoam.handlers.setupUserRequests()}else{throw new Error("A zoteroRoam_settings object must be defined in order to use the extension. Read through the docs for basic setup examples.")}};