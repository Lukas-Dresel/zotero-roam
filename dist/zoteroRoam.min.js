/* @alixlahuec/zotero-roam 2021-03-06 */

(()=>{window.zoteroRoam={Shortcut:function(e){for(k in this.action=e.action,this.template={altKey:!1,ctrlKey:!1,metaKey:!1,shiftKey:!1},this.watcher={altKey:!1,ctrlKey:!1,metaKey:!1,shiftKey:!1},e.template)this.template[`${k}`]=e.template[`${k}`],this.watcher[`${k}`]=!1;Object.keys(this.template).every(e=>!1===this.template[e])&&(this.template={})},autoComplete:null,config:{autoComplete:{data:{src:async function(){return 0==zoteroRoam.data.items.length?[]:zoteroRoam.handlers.simplifyDataArray(zoteroRoam.data.items)},key:["title","authorsLastNames","year","tagsString"],cache:!1,results:e=>{return Array.from(new Set(e.map(e=>e.index))).map(t=>e.find(e=>e.index===t))}},selector:"#zotero-search-autocomplete",searchEngine:"strict",trigger:{event:["input","focus"]},highlight:!0,maxResults:20,sort:(e,t)=>e.value.authors.toLowerCase()<t.value.authors.toLowerCase()?-1:e.value.authors.toLowerCase()>t.value.authors.toLowerCase()?1:0,resultsList:{className:"zotero-search-results-list",idName:"zotero-search-results-list",container:e=>{e.classList.add("bp3-menu")}},resultItem:{element:"li",className:"zotero-search_result",idName:"zotero-search_result",content:(e,t)=>{var o,a=`<span class="bp3-menu-item-label zotero-search-item-key">${e.value.key}</span>`,r=`<span class="zotero-search-item-metadata"> ${e.value.meta}</span>`,n=`<span class="zotero-search-item-title" style="font-weight:bold;color:black;display:block;">${"title"==e.key?e.match:e.value.title}</span>`;let i="";e.value.year&&(o="year"==e.key?e.match:e.value.year,i=`<span class="zotero-search-item-year"> (${o})</span>`);let s="";e.value.authors&&(s="authorsLastNames"==e.key?`<span class="zotero-search-item-authors autoComplete_highlighted">${e.value.authors}</span>`:`<span class="zotero-search-item-authors">${e.value.authors}</span>`);let l="";e.value.tagsString&&(o="tagsString"==e.key?e.match:e.value.tagsString,l=`<span class="zotero-search-item-tags" style="font-style:italic;color:#c1c0c0;display:block;">${o}</span>`),t.innerHTML=`<a label="${e.value.key}" class="bp3-menu-item bp3-popover-dismiss">
                                            <div class="bp3-text-overflow-ellipsis bp3-fill zotero-search-item-contents">
                                            ${n}
                                            ${s}${i}${r}
                                            ${l}
                                            </div>
                                            ${a}
                                            </a>`}},noResults:(e,t)=>{t(zoteroRoam.autoComplete,e,e.results);const o=document.createElement("li");o.setAttribute("class","no_result"),o.setAttribute("tabindex","1"),o.innerHTML=`<span style="display: flex; align-items: center; font-weight: 100; color: rgba(0,0,0,.2);">Found No Results for "${e.query}"</span>`,document.querySelector(`#${zoteroRoam.autoComplete.resultsList.idName}`).appendChild(o)},onSelection:e=>{zoteroRoam.interface.search.quickCopyToggle.checked&&!zoteroRoam.config.params.override_quickcopy.overridden?(zoteroRoam.interface.search.input.blur(),zoteroRoam.interface.search.input.value="@"+e.selection.value.key,zoteroRoam.interface.search.input.select(),document.execCommand("copy"),zoteroRoam.interface.toggleSearchOverlay("hide")):(zoteroRoam.interface.search.input.blur(),zoteroRoam.interface.renderSelectedItem(e))}},params:{override_quickcopy:{overridden:!1}},requests:{},shortcuts:[],userSettings:{}},data:{items:[],collections:[]},funcmap:{DEFAULT:"zoteroRoam.formatting.getItemMetadata"},typemap:{artwork:"Illustration",audioRecording:"Recording",bill:"Legislation",blogPost:"Blog post",book:"Book",bookSection:"Chapter",case:"Legal case",computerProgram:"Data",conferencePaper:"Conference paper",document:"Document",email:"Letter",encyclopediaArticle:"Encyclopaedia article",film:"Film",forumPost:"Forum post",hearing:"Hearing",instantMessage:"Instant message",interview:"Interview",journalArticle:"Article",letter:"Letter",magazineArticle:"Magazine article",manuscript:"Manuscript",map:"Image",newspaperArticle:"Newspaper article",patent:"Patent",podcast:"Podcast",presentation:"Presentation",radioBroadcast:"Radio broadcast",report:"Report",statute:"Legislation",thesis:"Thesis",tvBroadcast:"TV broadcast",videoRecording:"Recording",webpage:"Webpage"},addAutoCompleteCSS(){let e=document.createElement("style");e.textContent=`ul#zotero-search-results-list::before{content:attr(aria-label);}
                                            li.autoComplete_selected{background-color:#e7f3f7;}
                                            span.autoComplete_highlighted{color:#146cb7;}
                                            .selected-item-header, .selected-item-body{display:flex;justify-content:space-around;}
                                            .item-basic-metadata, .item-additional-metadata{flex: 0 1 60%;}
                                            .item-citekey, .item-actions{flex:0 1 30%;}
                                            .item-citekey{margin:10px 0px;}
                                            .item-citekey input.bp3-input[readonly]{box-shadow:none;font-weight:bold;}
                                            span.zotero-roam-sequence{background-color:khaki;padding:3px 6px;border-radius:3px;font-size:0.85em;font-weight:normal;}`,document.head.append(e)}};var e=document.createElement("script");e.src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@8.3.2/dist/js/autoComplete.js",e.type="text/javascript",document.getElementsByTagName("head")[0].appendChild(e)})(),zoteroRoam.utils={addBlock(e,t,o=0){window.roamAlphaAPI.createBlock({location:{"parent-uid":e,order:o},block:{string:t}})},executeFunctionByName(e,t){for(var o=Array.prototype.slice.call(arguments,2),a=e.split("."),r=a.pop(),n=0;n<a.length;n++)t=t[a[n]];return t[r].apply(t,o)},formatBib(e){e=e.match('csl-entry">(.+)</div>')[1];let t=document.createElement("textarea");t.innerHTML=e;let o=t.innerText;return o=o.replaceAll(/<\/?i>/g,"__"),o},formatItemNotes(e){return e.map(e=>{let t=e.data.note.split("\n");return t.map(e=>zoteroRoam.utils.parseNoteBlock(e)).filter(e=>e.trim())})},getTopBlockData(e){var t=window.roamAlphaAPI.q("[:find ?bUID ?bText :in $ ?pUID :where[?b :block/uid ?bUID][?b :block/string ?bText][?b :block/order 0][?p :block/children ?b][?p :block/uid ?pUID]]",e);if(void 0===t||null==t||0==t.length)return!1;try{return{uid:t[0][0],text:t[0][1]}}catch(e){console.error(e)}},lookForPage(e){let t=null;e=window.roamAlphaAPI.q("[:find ?uid :in $ ?title :where[?p :block/uid ?uid][?p :node/title ?title]]",e);return t=0<e.length?{present:!0,uid:e[0][0]}:{present:!1},t},makeDNP(e){return`${["January","February","March","April","May","June","July","August","September","October","November","December"][(e=e.constructor!==Date?new Date(e):e).getMonth()]} ${zoteroRoam.utils.makeOrdinal(e.getDate())}, ${e.getFullYear()}`},makeOrdinal(e){var t=e%10;return 1==t&11!=e?e+"st":2==t&12!=e?e+"nd":3==t&13!=e?e+"rd":e+"th"},makePDFLinks(e){return 0<e.length&&e.map(e=>"linked_file"==e.data.linkMode?`[${e.data.title}](zotero://open-pdf/library/items/${e.data.key})`:`[${e.data.title}](${e.data.url})`)},parseNoteBlock(e){let t=e;var o={"<p>":"","</p>":"","<blockquote>":"> ","</blockquote>":"","<strong>":"**","</strong>":"**","<em>":"__","</em>":"__","<b>":"**","</b>":"**","<br />":"\n"};for(prop in o)t=t.replaceAll(`${prop}`,`${o[prop]}`);return t=t.replaceAll(/<a href="(.+)">(.+)<\/a>/g,"[$2]($1)"),t},renderBP3Tag(e,t=""){return`<span class="bp3-tag bp3-minimal ${t}" style="margin:5px;">${e}</span>`},renderHTMLBlockObject(e){let t="";if(void 0===e.string)throw alert("Some of the input was passed as an Object but without a string property. See console for more details"),console.log(e),new Error("All blocks passed as an Object must have a string property");return t+=`<li>${e.string}`,void 0!==e.children&&0<e.children.length&&(t+=zoteroRoam.utils.renderHTMLMetadataArray(e.children)),t+=" </li>",t},renderHTMLMetadataArray(e){let t="<ul>";return e.forEach(e=>{if(e.constructor===Object)t+=zoteroRoam.utils.renderHTMLBlockObject(e);else{if(e.constructor!==String)throw alert("Some of the input was of the wrong type. See the console for more details"),console.log(e),new Error("All array items should be of type String or Object");t+=`<li>${e} </li>`}}),t+="</ul>",t},renderPageReference(e,t){return`<span data-link-title="${e}" data-link-uid="${t}">
            <span tabindex="-1" class="rm-page-ref rm-page-ref--link">${e}</span></span>`},renderPageTag(e){return`<span tabindex="-1" data-tag="${e}" class="rm-page-ref rm-page-ref--tag">#${e}</span>`},sleep(t){return new Promise(e=>setTimeout(e,t))}},zoteroRoam.handlers={async addBlockObject(e,t){if(void 0===t.string)throw console.log(t),new Error("All blocks passed as an Object must have a string property");if(zoteroRoam.utils.addBlock(uid=e,blockString=t.string,order=0),void 0!==t.children){var o=await zoteroRoam.handlers.waitForBlockUID(e,t.string);for(j=t.children.length-1;0<=j;j--)if(t.children[j].constructor===Object)await zoteroRoam.handlers.addBlockObject(o,t.children[j]);else{if(t.children[j].constructor!==String)throw new Error("All children array items should be of type String or Object");zoteroRoam.utils.addBlock(uid=o,blockString=t.children[j],order=0)}}},async addItemData(e){try{var t=e.parentElement.dataset.linkTitle.replace("@",""),o=e.parentElement.dataset.linkUid,a=zoteroRoam.data.items.find(e=>e.key==t);!a||0<(a=await zoteroRoam.handlers.formatData(a)).length&&await zoteroRoam.handlers.addMetadataArray(page_uid=o,arr=a)}catch(e){console.error(e)}},async addMetadataArray(e,t){if(0<t.length)for(k=t.length-1;0<=k;k--)if(t[k].constructor===Object)await zoteroRoam.handlers.addBlockObject(e,t[k]);else{if(t[k].constructor!==String)throw console.log(t[k]),new Error("All array items should be of type String or Object");zoteroRoam.utils.addBlock(uid=e,blockString=t[k],order=0)}else console.log("The metadata array was empty ; nothing was done.")},async addSearchResult(e,t){var o=e.replace("@",""),a=zoteroRoam.data.items.find(function(e){return e.key==o}),r=await zoteroRoam.handlers.formatData(a);if(!(a&&0<r.length))throw console.log(a),console.log(r),new Error("Something went wrong when attempting to format the item's data.");if(t)await zoteroRoam.handlers.addMetadataArray(page_uid=t,arr=r);else{window.roamAlphaAPI.createPage({page:{title:e}});var n=await zoteroRoam.handlers.waitForPageUID(e);if(null==n)throw console.log(n),new Error("There was a problem in obtaining the page's UID.");try{if(0<r.length){await zoteroRoam.handlers.addMetadataArray(page_uid=n,arr=r),await zoteroRoam.utils.sleep(100);let e=window.roamAlphaAPI.q("[:find (count ?chld) :in $ ?uid :where[?p :block/uid ?uid][?p :block/children ?chld]]",n);var i=0<e.length?e.toString():"__";alert(`Page was successfully added to the graph.
                                It currently has ${i} child blocks.`)}else alert("Page was created, but its metadata array was empty.")}catch(e){console.error(e),alert("Something went wrong when creating the page & adding the metadata")}1==zoteroRoam.utils.lookForPage(e).present||alert("Something went wrong in creating the page")}},extractCitekeys(e){return e.map(e=>(void 0!==e.data.extra&&e.data.extra.includes("Citation Key: ")&&(e.key=e.data.extra.match("Citation Key: (.+)")[1]),e))},async fetchData(r,n,t){var o=`https://api.zotero.org/${n}?${t}`;let s=[];try{let e=await fetch(o,{method:"GET",headers:{"Zotero-API-Version":3,"Zotero-API-Key":r}});if(1==e.ok){var l=e.headers.get("Total-Results");let a=new URLSearchParams(t);var c=a.has("start")?Number(a.get("start")):0,d=a.has("limit")?Number(a.get("limit")):100;s=await e.json();var m=c+s.length;if(m<l){var u=Math.ceil((l-m)/d);let e=[];for(i=1;i<=u;i++){var p=m+d*(i-1);a.set("start",p),a.set("limit",d),e.push(fetch(`https://api.zotero.org/${n}?${a.toString()}`,{method:"GET",headers:{"Zotero-API-Version":3,"Zotero-API-Key":r}}))}let t=await Promise.all(e),o=await Promise.all(t.map(e=>e.json()));o=o.flat(1),s.push(...o)}}else console.log(`The request for ${e.url} returned a code of ${e.status}`)}catch(e){console.error(e)}finally{return{data:s}}},async formatData(e){var t=e.data.itemType;let o=zoteroRoam.funcmap.DEFAULT;zoteroRoam.config.userSettings.funcmap&&(o=zoteroRoam.config.userSettings.funcmap[`${t}`]||zoteroRoam.config.userSettings.funcmap.DEFAULT||o);try{return await zoteroRoam.utils.executeFunctionByName(o,window,e)}catch(e){return console.error(e),console.log(`There was a problem when formatting the item with function ${o}`),[]}},setupUserRequests(){if(!zoteroRoam.config.userSettings.dataRequests)throw new Error("At least one data request object needs to be specified in order to use the extension. Read through the docs for basic setup examples.");{let e=zoteroRoam.config.userSettings.dataRequests;e=e.constructor===Array?e:[e];var o=e.find(e=>void 0!==e.apikey).apikey,a=e.find(e=>void 0!==e.params).params;e=e.map((e,t)=>(e.name=e.name||`${t}`,e.apikey=e.apikey||o,e.params=e.params||a,e)),zoteroRoam.config.requests=e}},async requestData(r){if(0==zoteroRoam.config.requests.length)throw new Error("No data requests were added to the config object - check for upstream problems");try{let o=[],a=[];r.forEach(e=>{var t=e.dataURI.match(/(users|groups)\/(.+)\//g)[0].slice(0,-1);o.push(zoteroRoam.handlers.fetchData(apiKey=e.apikey,dataURI=e.dataURI,params=e.params)),a.push(fetch(`https://api.zotero.org/${t}/collections`,{method:"GET",headers:{"Zotero-API-Version":3,"Zotero-API-Key":e.apikey}}))});let e=await Promise.all(o);e=e.map((e,t)=>e.data.map(e=>(e.requestLabel=r[t].name,e.requestIndex=t,e))).flat(1),e=zoteroRoam.handlers.extractCitekeys(e);let t=await Promise.all(a);return t=await Promise.all(t.map(e=>e.json())),t=t.flat(1),{success:!0,data:{items:e,collections:t}}}catch(e){return console.error(e),{success:!1}}},async requestItemBib(e,t){var o="user"==e.library.type?"users":"groups",a=zoteroRoam.config.requests[`${e.requestIndex}`].apikey;let r=await fetch(`${o}/${e.library.id}/items/${e.data.key}?include=bib&style=${t}`,{method:"GET",headers:{"Zotero-API-Version":3,"Zotero-API-Key":a}});return(await r.json()).bib},async requestItemChildren(e){var t=zoteroRoam.config.requests[`${e.requestIndex}`].apikey;let o=await fetch(`${e.links.self.href}/children`,{method:"GET",headers:{"Zotero-API-Version":3,"Zotero-API-Key":t}});return await o.json()},simplifyDataArray(e){let t=e.filter(e=>"attachment"!=e.data.itemType&&"note"!=e.data.itemType);return t=t.map(e=>{let t={key:e.key,title:`${e.data.title||""}`,abstract:`${e.data.abstractNote||""}`,authors:`${e.meta.creatorSummary||""}`,year:`${e.meta.parsedDate?new Date(e.meta.parsedDate).getUTCFullYear().toString():""}`,meta:"",tags:e.data.tags.map(e=>e.tag),authorsFull:e.data.creators.map(e=>e.name||[e.firstName,e.lastName].filter(Boolean).join(" ")),authorsRoles:e.data.creators.map(e=>e.creatorType),authorsLastNames:e.data.creators.map(e=>e.lastName),tagsString:e.data.tags.map(e=>`#${e.tag}`).join(", ")};var o=[e.data.publicationTitle,e.data.university,e.data.bookTitle].filter(Boolean);return 0<o.length&&(t.meta+=`, ${o[0]}`),e.data.publisher&&(t.meta+=`, ${e.data.publisher}`,e.data.place&&(t.meta+=`: ${e.data.place}`)),e.data.volume&&(t.meta+=`, ${e.data.volume}`,e.data.issue&&(t.meta+=`(${e.data.issue})`)),t.meta=e.data.pages?t.meta+`, ${e.data.pages}.`:".",t}),t},async waitForBlockUID(e,t){let o=null,a=!1,r=0;try{do{if(o=zoteroRoam.utils.getTopBlockData(e),void 0!==o.text&&o.text==t)return a=!0,o.uid}while(r+=1,await zoteroRoam.utils.sleep(75),r<50&&!a);throw console.log(o),new Error("The top block couldn't be matched")}catch(e){console.error(e)}},async waitForPageUID(e){let t=!1,o=0;do{var a=zoteroRoam.utils.lookForPage(e);if(1==a.present)return t=!0,a.uid}while(o+=1,await zoteroRoam.utils.sleep(75),o<50&&!t);throw new Error(`The page with title "${e}" couldn\'t be found`)}},zoteroRoam.interface={icon:null,portal:{div:null,id:"zotero-data-importer-portal"},contextMenu:{div:null,class:"zotero-context-menu",overlay:{div:null,class:"zotero-context-overlay"},options:{list:[],class:"zotero-context-menu-option",labels:["Import Zotero data to page"]},visible:!1,targetElement:null,position({top:e,left:t}){zoteroRoam.interface.contextMenu.div.style.left=`${t}px`,zoteroRoam.interface.contextMenu.div.style.top=`${e}px`,zoteroRoam.interface.toggleContextOverlay("contextMenu","show")}},iconContextMenu:{div:null,class:"zotero-icon-context-menu",overlay:{div:null,class:"zotero-icon-context-overlay"},options:{list:[],class:"zotero-icon-context-menu-option",labels:["Update Zotero data","Search in dataset..."]},visible:!1,position({top:e,left:t}){zoteroRoam.interface.iconContextMenu.div.style.left=t>=.9*window.innerWidth?`calc(${t}px - 10%)`:`${t}px`,zoteroRoam.interface.iconContextMenu.div.style.top=`calc(${e}px + 3%)`,zoteroRoam.interface.toggleContextOverlay("iconContextMenu","show")}},search:{overlay:null,input:null,selectedItemDiv:null,quickCopyToggle:null,closeButton:null,updateButton:null,visible:!1},create(){zoteroRoam.interface.createIcon(id="zotero-data-icon"),zoteroRoam.interface.portal.div=zoteroRoam.interface.createPortal(id=zoteroRoam.interface.portal.id),zoteroRoam.interface.createContextMenu(elementKey="contextMenu"),zoteroRoam.interface.createContextMenu(elementKey="iconContextMenu"),zoteroRoam.interface.createSearchOverlay()},setup(){zoteroRoam.interface.icon.addEventListener("click",zoteroRoam.extension.toggle),zoteroRoam.interface.setupContextMenus(["contextMenu","iconContextMenu"]),zoteroRoam.interface.search.updateButton.addEventListener("click",zoteroRoam.extension.update),zoteroRoam.interface.search.closeButton.addEventListener("click",function(){zoteroRoam.interface.toggleSearchOverlay("hide")}),zoteroRoam.interface.search.input.addEventListener("rendered",zoteroRoam.interface.renderNbResults)},createIcon(e){try{document.getElementById(e).closest(".bp3-popover-wrapper").remove()}catch(e){}var t=document.createElement("span");t.classList.add("bp3-popover-wrapper"),t.setAttribute("style","margin-left: 4px;"),t.innerHTML=`<span class="bp3-popover-target"><span id="${e}" status="off" class="bp3-button bp3-icon-manual bp3-minimal bp3-small"></span>`,document.querySelector(".rm-topbar").appendChild(t),zoteroRoam.interface.icon=document.getElementById(e)},createPortal(e){try{document.getElementById(e).remove()}catch(e){}var t=document.createElement("div");return t.classList.add("bp3-portal"),t.id=e,document.getElementById("app").appendChild(t),t},createContextMenu(e){let t=zoteroRoam.interface[`${e}`];try{document.querySelector(`.${t.overlay.class}`).remove()}catch(e){}var o=t.options.labels.map(e=>`<li class="${t.options.class}"><a class="bp3-menu-item bp3-popover-dismiss"><div class="bp3-fill bp3-text-overflow-ellipsis">${e}</div></a></li>`).join(""),a=document.createElement("div");a.classList.add("bp3-overlay"),a.classList.add("bp3-overlay-open"),a.classList.add(`${t.overlay.class}`),a.style="display:none;",a.innerHTML=`<div class="bp3-overlay-backdrop bp3-popover-backdrop bp3-popover-appear-done bp3-popover-enter-done" style="z-index:25;"></div>
                                    <div class="bp3-transition-container bp3-popover-appear-done bp3-popover-enter-done ${t.class}" style="width: auto; position: fixed;z-index:25;">
                                        <div class="bp3-popover bp3-minimal">
                                            <div class="bp3-popover-content">
                                                <div>
                                                    <ul class="bp3-menu bp3-text-small">
                                                        ${o}
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>`,zoteroRoam.interface.portal.div.appendChild(a),zoteroRoam.interface[`${e}`].overlay.div=document.querySelector(`.${zoteroRoam.interface[`${e}`].overlay.class}`),zoteroRoam.interface[`${e}`].div=document.querySelector(`.${zoteroRoam.interface[`${e}`].class}`),zoteroRoam.interface[`${e}`].options.list=document.querySelectorAll(`.${zoteroRoam.interface[`${e}`].options.class}`)},createSearchOverlay(){try{document.querySelector(".zotero-search-overlay").remove()}catch(e){}let e=document.createElement("div");e.classList.add("bp3-overlay"),e.classList.add("bp3-overlay-open"),e.classList.add("bp3-overlay-scroll-container"),e.classList.add("zotero-search-overlay"),e.style="display:none;";let t=document.createElement("div");t.classList.add("bp3-overlay-backdrop"),t.classList.add("bp3-overlay-appear-done"),t.classList.add("bp3-overlay-enter-done"),t.classList.add("zotero-search-backdrop"),t.tabIndex="0";let o=document.createElement("div");o.classList.add("bp3-dialog-container"),o.classList.add("bp3-overlay-content"),o.classList.add("bp3-overlay-appear-done"),o.classList.add("bp3-overlay-enter-done"),o.tabIndex="0";let a=document.createElement("div");a.classList.add("bp3-dialog"),a.style="width:60%;align-self:baseline;";let r=document.createElement("div");r.classList.add("bp3-dialog-header");let n=document.createElement("div");n.classList.add("bp3-dialog-body");let i=document.createElement("div");i.classList.add("bp3-dialog-footer"),r.innerHTML=`<label class="bp3-control bp3-switch" style="margin-bottom:0px;flex: 1 1 auto;">
                                            <input id="zotero-quick-copy-mode" type="checkbox"><span class="bp3-control-indicator"></span>Quick Copy</label>
                                            <button type="button" aria-label="Close" class="zotero-search-close bp3-button bp3-minimal bp3-dialog-close-button">
                                            <span icon="small-cross" class="bp3-icon bp3-icon-small-cross"></span></button>`;let s=document.createElement("p");s.innerHTML=`<strong>Enter text below to look for items* in your loaded Zotero dataset.</strong>
                            <br>(* searchable fields are : title, year, authors, tags. A more fully-featured search will be available down the road)`,n.appendChild(s);let l=document.createElement("input");l.id="zotero-search-autocomplete",l.tabIndex="1",l.type="text",l.classList.add("bp3-input"),l.classList.add("bp3-fill"),l.style="margin-bottom:20px;",n.appendChild(l);let c=document.createElement("div");c.id="zotero-search-selected-item",c.classList.add("bp3-card"),c.style="width:95%;margin:0 auto;display:none;";let d=document.createElement("div");d.classList.add("selected-item-header");let m=document.createElement("div");m.classList.add("selected-item-body"),c.appendChild(d),c.appendChild(m),n.appendChild(c),i.innerHTML=`<div class="bp3-dialog-footer-actions">
                                            <span class="bp3-popover2-target" tabindex="0">
                                            <button type="button" class="zotero-update-data bp3-button">
                                            <span class="bp3-button-text">Update Zotero data</span>
                                            </button></span></div>`,a.appendChild(r),a.appendChild(n),a.appendChild(i),o.appendChild(a),e.appendChild(t),e.appendChild(o),zoteroRoam.interface.portal.div.appendChild(e),zoteroRoam.interface.search.overlay=document.querySelector(".zotero-search-overlay"),zoteroRoam.interface.search.input=document.querySelector("#zotero-search-autocomplete"),zoteroRoam.interface.search.selectedItemDiv=document.querySelector("#zotero-search-selected-item"),zoteroRoam.interface.search.quickCopyToggle=document.querySelector("#zotero-quick-copy-mode"),zoteroRoam.interface.search.closeButton=document.querySelector("button.zotero-search-close"),zoteroRoam.interface.search.updateButton=document.querySelector("button.zotero-update-data")},setupContextMenus(t){window.addEventListener("click",e=>{t.forEach(e=>{zoteroRoam.interface[`${e}`].visible&&zoteroRoam.interface.toggleContextOverlay(e,command="hide")})}),t.forEach(o=>{zoteroRoam.interface[`${o}`].options.list.forEach((e,t)=>{switch(zoteroRoam.interface[`${o}`].options.labels[t]){case"Import Zotero data to page":e.addEventListener("click",function(){zoteroRoam.handlers.addItemData(zoteroRoam.interface.contextMenu.targetElement)});break;case"Update Zotero data":e.addEventListener("click",zoteroRoam.extension.update);break;case"Search in dataset...":e.addEventListener("click",function(){zoteroRoam.interface.toggleSearchOverlay("show")})}})})},toggleContextOverlay(e,t){zoteroRoam.interface[`${e}`].overlay.div.style.display="show"==t?"block":"none",zoteroRoam.interface[`${e}`].visible="show"==t},toggleSearchOverlay(e){zoteroRoam.interface.search.overlay.style.display="show"===e?"block":"none","show"==e?(zoteroRoam.interface.search.input.focus(),zoteroRoam.interface.search.visible=!0):(zoteroRoam.interface.clearSelectedItem(),zoteroRoam.interface.search.input.value="",zoteroRoam.interface.search.visible=!1)},popContextOverlay(e,t){e.preventDefault();var o={left:e.pageX,top:e.pageY};return zoteroRoam.interface[`${t}`].position(o),"contextMenu"==t&&(zoteroRoam.interface.contextMenu.targetElement=e.target),!1},popContextMenu(e){zoteroRoam.interface.popContextOverlay(e,"contextMenu")},popIconContextMenu(e){zoteroRoam.interface.popContextOverlay(e,"iconContextMenu")},renderNbResults(e){let t="";0<e.detail.results.length&&(t=`Showing ${e.detail.results.length} out of ${e.detail.matches.length} results`),document.querySelector("#zotero-search-results-list").setAttribute("aria-label",t)},renderSelectedItem(e){var t="@"+e.selection.value.key,o=e.selection.value.year?" ("+e.selection.value.year+")":"",a=e.selection.value.authorsFull,r=e.selection.value.authorsRoles;let n="";if(0<a.length)for(i=0;i<a.length;i++){var s=zoteroRoam.utils.lookForPage(title=a[i]),l=1==s.present?zoteroRoam.utils.renderPageReference(title=a[i],uid=s.uid):zoteroRoam.utils.renderBP3Tag(string=a[i],modifier="bp3-intent-primary bp3-round"),s=r[i]&&"author"!=r[i]?` (${r[i]})`:"";n=n+l+s,i<a.length-2?n+=", ":i==a.length-2&&(n+=" & ")}var c=e.selection.value.tags;let d="";if(0<c.length)for(i=0;i<c.length;i++){var m=1==zoteroRoam.utils.lookForPage(title=c[i]).present?zoteroRoam.utils.renderPageTag(title=c[i]):zoteroRoam.utils.renderBP3Tag(string=c[i]);d=d+m+" "}var u=zoteroRoam.utils.lookForPage(t);let p=document.querySelector(".selected-item-header");p.innerHTML=`<div class="item-basic-metadata">
                                        <h4 class="item-title">${e.selection.value.title}${o}</h4>
                                        <p class="item-metadata-string">${n}${e.selection.value.meta}</p>
                                        </div>
                                    <div class="item-citekey">
                                        <div class="bp3-control-group">
                                            <div class="bp3-input-group bp3-fill"><input type="text" class="bp3-input" value="${t}" readonly></div>
                                            <button type="button" class="bp3-button item-copy-citekey"><span icon="clipboard" class="bp3-icon bp3-icon-clipboard"></span></button>
                                        </div>
                                    </div>`;let h=document.querySelector(".selected-item-body");var g=u.uid||"",y=1==u.present?"tick":"cross",f=1==u.present?"success":"danger",o=1==u.present?"Page already exists in the graph":"Page doesn't exist in the graph",u=zoteroRoam.shortcuts.sequences.importMetadata?zoteroRoam.shortcuts.makeSequenceText("importMetadata",pre=" "):"";h.innerHTML=`<div class="item-additional-metadata">
                                    <p class="item-abstract">${e.selection.value.abstract}</p>
                                    <p class="item-tags">${d}</p>
                                </div>
                                <div class="item-actions">
                                    <div style="padding:5px 10px;font-style:italic;"><span class="bp3-icon-${y} bp3-icon bp3-intent-${f}"></span><span> ${o}</span></div>
                                    <div class="bp3-button-group bp3-minimal bp3-vertical bp3-align-left">
                                    <button type="button" class="bp3-button item-add-metadata">
                                        <span icon="add" class="bp3-icon bp3-icon-add bp3-intent-primary"></span>
                                        <span class="bp3-button-text">Import metadata</span>
                                        ${u}
                                    </button>
                                    </div>
                                </div>`,document.querySelector("button.item-add-metadata").addEventListener("click",function(){zoteroRoam.handlers.addSearchResult(t,g)}),document.querySelector("button.item-copy-citekey").addEventListener("click",function(){document.querySelector(".item-citekey input").select(),document.execCommand("copy"),document.querySelector(".item-citekey input").blur()}),zoteroRoam.interface.search.selectedItemDiv.style.display="block"},clearSelectedItem(){zoteroRoam.interface.search.selectedItemDiv.children.forEach(e=>{e.innerHTML=""}),zoteroRoam.interface.search.selectedItemDiv.style.display="none"}},zoteroRoam.extension={async load(){zoteroRoam.interface.icon.style="background-color: #fd9d0d63!important;";var e=await zoteroRoam.handlers.requestData(zoteroRoam.config.requests);if(!e.success)throw zoteroRoam.interface.icon.style="background-color:#f9a3a3 !important",new Error("The API request encountered a problem. Please check your request specification, and the console for any registered errors.");zoteroRoam.data.items=e.data.items,zoteroRoam.data.collections=e.data.collections,zoteroRoam.interface.icon.setAttribute("status","on"),zoteroRoam.pageRefs.checkReferences(),document.addEventListener("blur",zoteroRoam.pageRefs.checkReferences,!0),window.addEventListener("locationchange",zoteroRoam.pageRefs.checkReferences,!0),null==zoteroRoam.autoComplete?zoteroRoam.autoComplete=new autoComplete(zoteroRoam.config.autoComplete):zoteroRoam.autoComplete.init(),zoteroRoam.config.autoComplete.trigger.event.forEach(e=>{zoteroRoam.interface.search.input.addEventListener(e,zoteroRoam.interface.clearSelectedItem)}),zoteroRoam.interface.icon.addEventListener("contextmenu",zoteroRoam.interface.popIconContextMenu),window.addEventListener("keyup",zoteroRoam.shortcuts.verify),window.addEventListener("keydown",zoteroRoam.shortcuts.verify),zoteroRoam.interface.icon.style="background-color: #60f06042!important;",console.log("The results of the API request have been received ; you can check them by inspecting the value of the zoteroRoam.data object. Data import context menu should now be available.")},unload(){zoteroRoam.interface.icon.setAttribute("status","off"),zoteroRoam.data={items:[],collections:[]},null!==zoteroRoam.autoComplete&&zoteroRoam.autoComplete.unInit();let e=document.querySelectorAll("ref-citekey");e.forEach(e=>{e.removeAttribute("data-zotero-bib"),e.querySelector(".rm-page-ref").removeEventListener("contextmenu",zoteroRoam.interface.popContextMenu)}),zoteroRoam.interface.icon.removeEventListener("contextmenu",zoteroRoam.interface.popIconContextMenu),document.removeEventListener("blur",zoteroRoam.pageRefs.checkReferences,!0),window.removeEventListener("locationchange",zoteroRoam.pageRefs.checkReferences,!0),window.removeEventListener("keyup",zoteroRoam.shortcuts.verify),window.removeEventListener("keydown",zoteroRoam.shortcuts.verify),zoteroRoam.interface.icon.removeAttribute("style"),console.log("Data and request outputs have been removed")},toggle(){"off"==zoteroRoam.interface.icon.getAttribute("status")?zoteroRoam.extension.load():zoteroRoam.extension.unload()},async update(){zoteroRoam.interface.icon.style="background-color: #fd9d0d63!important;";var t=zoteroRoam.config.requests.map(t=>{let e=zoteroRoam.data.items.filter(e=>e.requestLabel==t.name);var o=e.reduce((e,t)=>e.version<t.version?t:e).version;let a=new URLSearchParams(t.params);return a.set("since",o),t.params=a.toString(),t}),t=await zoteroRoam.handlers.requestData(t);if(1==t.success){zoteroRoam.data.collections=t.data.collections;let e=t.data.items;if(0==e.length)alert("No new items were found since the data was last loaded. Data on collections was refreshed."),zoteroRoam.interface.icon.style="background-color: #60f06042!important;";else{let o=zoteroRoam.handlers.extractCitekeys(e).length,a=0;e.forEach(t=>{var e=zoteroRoam.data.items.findIndex(e=>e.key==t.key&e.requestLabel==t.requestLabel);-1==e?zoteroRoam.data.items.push(t):(zoteroRoam.data.items[e]=t,a+=1,--o)}),zoteroRoam.pageRefs.checkCitekeys(update=!0),alert(`${o} new items and ${a} modified items were added to the dataset. Data on collections was refreshed.`),zoteroRoam.interface.icon.style="background-color: #60f06042!important;"}}else alert("Something went wrong when updating the data. Check the console for any errors.")}},zoteroRoam.pageRefs={addContextMenuListener(){for(var e=document.querySelectorAll(".ref-citekey"),t=0;t<e.length;t++){var o=e[t];o.dataset.zoteroBib||(zoteroRoam.data.items.find(e=>e.key==o.dataset.linkTitle.replace("@",""))?o.dataset.zoteroBib="inLibrary":o.dataset.zoteroBib="notFound"),"inLibrary"==o.dataset.zoteroBib?o.querySelector(".rm-page-ref").addEventListener("contextmenu",zoteroRoam.interface.popContextMenu):"notFound"==o.dataset.zoteroBib&&console.log("This citekey was checked against the contents of ZoteroData but didn't match any item. Make sure your citekeys are pinned.")}},checkReferences(){var t;setTimeout(function(){do{var e=document.getElementsByClassName("rm-page-ref");t=zoteroRoam.pageRefs.identifyCitekeys(e)}while(1==t)},300),zoteroRoam.pageRefs.checkCitekeys(update=!0),zoteroRoam.pageRefs.addContextMenuListener()},identifyCitekeys(t){let o=!1;for(i=0;i<t.length;i++){let e=t[i].parentElement;void 0!==e.dataset.linkTitle&&e.dataset.linkTitle.startsWith("@")&&(o=!e.classList.contains("ref-citekey")&&(e.classList.add("ref-citekey"),!0))}return o},checkCitekeys(e="false"){let t=document.querySelectorAll(".ref-citekey"),o=0,a=0;t.forEach(t=>{if(t.dataset.zoteroBib)1==e&&"notFound"==t.dataset.zoteroBib&&(zoteroRoam.data.items.find(e=>e.key==t.dataset.linkTitle.replace("@",""))?(t.dataset.zoteroBib="inLibrary",o+=1):a+=1);else switch(t.dataset.zoteroBib=zoteroRoam.data.items.find(e=>e.key==t.dataset.linkTitle.replace("@",""))?"inLibrary":"notFound",t.dataset.zoteroBib){case"inLibrary":o+=1;break;case"notFound":a+=1}}),0<o|0<a&&console.log(`New matched citekeys: ${o}, New unmatched citekeys: ${a}`)}},zoteroRoam.formatting={getCreators(e){return e.data.creators.map(e=>{let t=e.name?`[[${e.name}]]`:`[[${[e.firstName,e.lastName].filter(Boolean).join(" ")}]]`;return"author"!=e.creatorType&&(t=t+" ("+e.creatorType+")"),t}).join(", ")},async getItemBib(e,t="apa"){t=e.bib||await zoteroRoam.handlers.requestItemBib(e,t);return zoteroRoam.utils.formatBib(t)},async getItemChildren(t){let e={pdfItems:!1,notes:!1},o=[];var a;return 0<t.meta.numChildren&&(a=zoteroRoam.data.items.filter(e=>e.data.parentItem==t.data.key&e.library.id==t.library.id),o=0==a.length?await zoteroRoam.handlers.requestItemChildren(t)||[]:a),e.pdfItems=zoteroRoam.utils.makePDFLinks(o.filter(e=>"application/pdf"==e.data.contentType)),e.notes=zoteroRoam.utils.formatItemNotes(o.filter(e=>"note"==e.data.itemType)),e},getItemCollections(o){return 0<o.data.collections.length&&o.data.collections.map(t=>zoteroRoam.data.collections.find(e=>e.key==t&&e.library.id==o.library.id))},getItemType(e){let t=zoteroRoam.typemap[e.data.itemType]||e.data.itemType;return zoteroRoam.config.userSettings.typemap&&(t=zoteroRoam.config.userSettings.typemap[e.data.itemType]||t),t},getLocalLink(e,t="Local library"){return`[${t}](zotero://select/library/items/${e.data.key})`},getWebLink(e,t="Web library"){e.library.type="user";return`[${t}](https://www.zotero.org/users/${e.library.id}/items/${e.data.key})`},getTags(e){return e.data.tags.map(e=>"#[["+e.tag+"]]").join(", ")},getItemMetadata(e){let t=[];return e.data.title&&t.push(`Title:: ${e.data.title}`),0<e.data.creators.length&&t.push(`Author(s):: ${zoteroRoam.formatting.getCreators(e)}`),e.data.abstractNote&&t.push(`Abstract:: ${e.data.abstractNote}`),e.data.itemType&&t.push(`Type:: [[${zoteroRoam.formatting.getItemType(e)}]]`),t.push(`Publication:: ${e.data.publicationTitle||e.data.bookTitle||""}`),e.data.url&&t.push(`URL : ${e.data.url}`),e.data.dateAdded&&t.push(`Date Added:: [[${zoteroRoam.utils.makeDNP(e.data.dateAdded)}]]`),t.push(`Zotero links:: ${zoteroRoam.formatting.getLocalLink(e)}, ${zoteroRoam.formatting.getWebLink(e)}`),0<e.data.tags.length&&t.push(`Tags:: ${zoteroRoam.formatting.getTags(e)}`),t}},zoteroRoam.shortcuts={actions:{closeSearchPanel:{defaultShortcut:{Escape:!0},execute(){zoteroRoam.interface.search.visible&&zoteroRoam.interface.toggleSearchOverlay("hide")}},toggleSearchPanel:{defaultShortcut:{altKey:!0,q:!0},execute(){var e=zoteroRoam.interface.search.visible?"hide":"show";zoteroRoam.interface.toggleSearchOverlay(e)}},toggleQuickCopy:{defaultShortcut:[],execute(){document.getElementById("zotero-quick-copy-mode").click()}},importMetadata:{defaultShortcut:[],execute(){let e=document.querySelector("button.item-add-metadata");null!==e&&e.click()}}},sequences:{},getSequences(t){let o=zoteroRoam.config.shortcuts.filter(e=>e.action==t);if(0==o.length)return!1;{let e=o.map(e=>{let t=[];for(key in e.template)1==e.template[key]&&t.push(key);return t});return e.map(e=>e.join("+")).join(" or ")}},generateSequences(){for(action in zoteroRoam.shortcuts.actions){var e=zoteroRoam.shortcuts.getSequences(action);e&&(zoteroRoam.shortcuts.sequences[action]=e)}},makeSequenceText(e,t="",o){return`${t}<span class="zotero-roam-sequence">${zoteroRoam.shortcuts.sequences[e]}</span>`},setup(){let o={};Object.keys(zoteroRoam.shortcuts.actions).forEach(e=>{o[e]=zoteroRoam.shortcuts.actions[e].defaultShortcut});let a={};zoteroRoam.config.userSettings.shortcuts?Object.keys(zoteroRoam.shortcuts.actions).forEach(e=>{var{[e]:t=o[e]}=zoteroRoam.config.userSettings.shortcuts;a[e]=t}):a=o;let t=[];for(k in a)a[k].constructor===Object?t.push({action:k,template:a[k]}):a[k].constructor===Array&&a[k].forEach(e=>{t.push({action:k,template:e})});t.forEach(e=>{zoteroRoam.config.shortcuts.push(new zoteroRoam.Shortcut(e))}),zoteroRoam.shortcuts.generateSequences();let r=zoteroRoam.shortcuts.sequences.toggleSearchPanel?zoteroRoam.shortcuts.makeSequenceText("toggleSearchPanel",pre="Toggle with "):"",n=zoteroRoam.shortcuts.sequences.closeSearchPanel?zoteroRoam.shortcuts.makeSequenceText("closeSearchPanel",pre="Exit with "):"";if(0<r.length|0<n.length){let e=document.createElement("span");e.style="font-style:italic;",e.innerHTML=`${[r,n].filter(Boolean).join(" / ")}  `;let t=document.querySelector(".zotero-search-overlay .bp3-dialog-header");t.insertBefore(e,zoteroRoam.interface.search.closeButton)}var i=zoteroRoam.shortcuts.sequences.toggleQuickCopy?zoteroRoam.shortcuts.makeSequenceText("toggleQuickCopy",pre=" "):"";if(0<i.length){let e=document.querySelector(".zotero-search-overlay .bp3-dialog-header");e.querySelector(".bp3-control.bp3-switch").innerHTML+=i}},verify(o){var e=o.key,a="keydown"==o.type;let r=["altKey","ctrlKey","metaKey","shiftKey"];zoteroRoam.config.shortcuts.forEach(t=>{r.forEach(e=>{t.watcher[`${e}`]=o[`${e}`]}),t.template.hasOwnProperty(e)&&(t.watcher[`${e}`]=a)}),zoteroRoam.config.shortcuts.forEach(e=>{JSON.stringify(e.watcher)===JSON.stringify(e.template)&&zoteroRoam.shortcuts.actions[`${e.action}`].execute()})}},(()=>{if(void 0===window.zoteroRoam_settings)throw new Error("A zoteroRoam_settings object must be defined in order to use the extension. Read through the docs for basic setup examples.");zoteroRoam.interface.create(),zoteroRoam.interface.setup(),zoteroRoam.addAutoCompleteCSS(),zoteroRoam.config.userSettings=window.zoteroRoam_settings;var e=zoteroRoam.config.userSettings.override_quickcopy||!1;e&&(zoteroRoam.config.params.override_quickcopy.key=e,window.addEventListener("keydown",e=>{e.key==zoteroRoam.config.params.override_quickcopy.key|1==e[zoteroRoam.config.params.override_quickcopy.key]&&(zoteroRoam.config.params.override_quickcopy.overridden=!0)}),window.addEventListener("keyup",e=>{e.key==zoteroRoam.config.params.override_quickcopy.key|0==e[zoteroRoam.config.params.override_quickcopy.key]&&(zoteroRoam.config.params.override_quickcopy.overridden=!1)})),zoteroRoam.shortcuts.setup(),zoteroRoam.handlers.setupUserRequests()})();