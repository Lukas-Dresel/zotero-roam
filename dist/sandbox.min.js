/* @alixlahuec/zotero-roam | 0.5.82 | 2021-06-01 */

var zoteroRoam={};(()=>{zoteroRoam={Shortcut:function(e){for(k in this.action=e.action,this.template={altKey:!1,ctrlKey:!1,metaKey:!1,shiftKey:!1},this.watcher={altKey:!1,ctrlKey:!1,metaKey:!1,shiftKey:!1},e.template)this.template[`${k}`]=e.template[`${k}`],this.watcher[`${k}`]=!1;Object.keys(this.template).every(e=>!1===this.template[e])&&(this.template={})},Pagination:function(e){this.data=e.data,this.itemsPerPage=e.itemsPerPage||zoteroRoam.config.params.citations.itemsPerPage,this.currentPage=1,this.nbPages=Math.ceil(this.data.length/this.itemsPerPage),this.startIndex=(this.currentPage-1)*this.itemsPerPage+1,this.updateStartIndex=function(){this.startIndex=(this.currentPage-1)*this.itemsPerPage+1},this.getCurrentPageData=function(){return this.getPageData(this.currentPage)},this.getPageData=function(e){return this.data.slice(start=this.itemsPerPage*(e-1),end=this.itemsPerPage*e)},this.previousPage=function(){--this.currentPage,this.currentPage<1&&(this.currentPage=1),this.updateStartIndex(),zoteroRoam.interface.renderCitationsPagination()},this.nextPage=function(){this.currentPage+=1,this.currentPage>this.nbPages&&(this.currentPage=this.nbPages),this.updateStartIndex(),zoteroRoam.interface.renderCitationsPagination()}},data:{items:[],collections:[],scite:[]},autoComplete:null,citations:{pagination:null,autocomplete:null,currentDOI:""},config:{autoComplete:{data:{src:async function(){return 0==zoteroRoam.data.items.length?[]:zoteroRoam.handlers.simplifyDataArray(zoteroRoam.data.items)},key:["title","authorsLastNames","year","tagsString","key","_multiField"],cache:!1,results:e=>{return Array.from(new Set(e.map(e=>e.index))).map(t=>e.filter(e=>e.index===t).sort((t,o)=>zoteroRoam.config.autoComplete.data.key.findIndex(e=>e==t.key)<zoteroRoam.config.autoComplete.data.key.findIndex(e=>o.key)?-1:1)[0])}},selector:"#zotero-search-autocomplete",searchEngine:(e,t)=>zoteroRoam.utils.multiwordMatch(e,t),trigger:{event:["input","focus"]},highlight:!0,maxResults:100,sort:(e,t)=>e.value.authors.toLowerCase()<t.value.authors.toLowerCase()?-1:e.value.authors.toLowerCase()>t.value.authors.toLowerCase()?1:0,resultsList:{className:"zotero-search-results-list",idName:"zotero-search-results-list",container:e=>{e.classList.add("bp3-menu")}},resultItem:{element:"li",className:"zotero-search_result",idName:"zotero-search_result",content:(e,t)=>{var o,a=`<span class="zotero-search-item-metadata"> ${e.value.meta}</span>`,r=`<span class="zotero-search-item-title" style="display:block;">${"title"==e.key?e.match:e.value.title}</span>`,i=`
                        <span class="bp3-menu-item-label zotero-search-item-key">
                        <a href="zotero://select/library/items/${e.value.itemKey}" destination="zotero">${e.value.key}</a>
                        </span>
                        `;let n="";e.value.year&&(o="year"==e.key?e.match:e.value.year,n=`<span class="zotero-search-item-year"> (${o})</span>`);let s="";e.value.authors&&(s="authorsLastNames"==e.key?`<span class="zotero-search-item-authors autoComplete_highlighted">${e.value.authors}</span>`:`<span class="zotero-search-item-authors">${e.value.authors}</span>`);let l="";e.value.tagsString&&(o="tagsString"==e.key?e.match:e.value.tagsString,l=`<span class="zotero-search-item-tags" style="display:block;">${o}</span>`),t.innerHTML=`<a label="${e.value.key}" class="bp3-menu-item bp3-popover-dismiss">
                                            <div class="bp3-text-overflow-ellipsis bp3-fill zotero-search-item-contents">
                                            ${r}
                                            ${s}${n}${a}
                                            ${l}
                                            </div>
                                            ${i}
                                            </a>`}},noResults:(e,t)=>{t(zoteroRoam.autoComplete,e,e.results);const o=document.createElement("li");o.setAttribute("class","no_result"),o.setAttribute("tabindex","1"),o.innerHTML=`<span style="display: flex; align-items: center; color: rgba(0,0,0,.2);">Found No Results for "${e.query}"</span>`,document.querySelector(`#${zoteroRoam.autoComplete.resultsList.idName}`).appendChild(o)},onSelection:o=>{zoteroRoam.interface.search.input.blur();var a=document.querySelector("#zotero-quick-copy-mode").checked;if(1==zoteroRoam.config.params.always_copy||a&&!zoteroRoam.config.params.override_quickcopy.overridden){let e=zoteroRoam.interface.search.overlay.querySelector("input.clipboard-copy-utility"),t="";if("citation"===zoteroRoam.config.params.quick_copy_format){let e=`${o.selection.value.authors||""}`;o.selection.value.year&&(e+=` (${o.selection.value.year})`),t=`[${e}]([[@${o.selection.value.key}]])`}else t=zoteroRoam.utils.formatItemReference(item=o.selection.value,format=zoteroRoam.config.params.quick_copy_format);e.value=t,e.select(),document.execCommand("copy"),a&&!zoteroRoam.config.params.override_quickcopy.overridden?zoteroRoam.interface.toggleSearchOverlay("hide"):zoteroRoam.interface.renderSelectedItem(o)}else zoteroRoam.interface.renderSelectedItem(o)}},citationsSearch:{data:{src:async function(){return 0==zoteroRoam.citations.currentDOI.length?[]:zoteroRoam.data.scite.find(e=>e.doi==zoteroRoam.citations.currentDOI).simplified},key:["year","title","keywords","authorsLastNames","abstract","meta"],results:e=>{return Array.from(new Set(e.map(e=>e.index))).map(t=>e.filter(e=>e.index===t).sort((t,o)=>zoteroRoam.config.citationsSearch.data.key.findIndex(e=>e==t.key)<zoteroRoam.config.citationsSearch.data.key.findIndex(e=>o.key)?-1:1)[0])}},selector:"#zotero-roam-citations-autocomplete",searchEngine:(e,t)=>zoteroRoam.utils.multiwordMatch(e,t),trigger:{event:["input"],condition:(e,t)=>!0},highlight:!0,maxResults:100,resultsList:{render:!1},noResults:(e,t)=>{let o=document.querySelector("#zotero-roam-citations-pagination");o.querySelector(".zotero-roam-citations-results-count").innerHTML=`
                    <strong>No results</strong> for ${e.query}
                    `,zoteroRoam.citations.pagination=new zoteroRoam.Pagination({data:[]});let a=o.querySelector("ul");a.innerHTML=""},feedback:e=>{e.results&&0<e.results.length?(zoteroRoam.citations.pagination=new zoteroRoam.Pagination({data:e.results.map(e=>e.value)}),zoteroRoam.interface.renderCitationsPagination()):zoteroRoam.interface.popCitationsOverlay(doi=zoteroRoam.citations.currentDOI)}},tribute:{trigger:"",selectClass:"zotero-roam-tribute-selected",containerClass:"zotero-roam-tribute",lookup:"display",menuItemLimit:15,menuItemTemplate:e=>e.original.display,requireLeadingSpace:!0,selectTemplate:e=>e.original.value,searchOpts:{skip:!0},values:(t,e)=>{let o=zoteroRoam.handlers.getLibItems(format=zoteroRoam.config.params.autocomplete.format,display=zoteroRoam.config.params.autocomplete.display);e(o.filter(e=>e[zoteroRoam.config.tribute.lookup].toLowerCase().includes(t.toLowerCase())))}},params:{override_quickcopy:{overridden:!1},always_copy:!1,quick_copy_format:"citekey",autocomplete:{enabled:!1,format:"citation",display:"citekey"},citations:{itemsPerPage:20}},requests:{},shortcuts:[],userSettings:{},ref_checking:null,page_checking:null,auto_update:null,editingObserver:null},funcmap:{DEFAULT:"zoteroRoam.formatting.getItemMetadata"},typemap:{artwork:"Illustration",audioRecording:"Recording",bill:"Legislation",blogPost:"Blog post",book:"Book",bookSection:"Chapter",case:"Legal case",computerProgram:"Data",conferencePaper:"Conference paper",document:"Document",email:"Letter",encyclopediaArticle:"Encyclopaedia article",film:"Film",forumPost:"Forum post",hearing:"Hearing",instantMessage:"Instant message",interview:"Interview",journalArticle:"Article",letter:"Letter",magazineArticle:"Magazine article",manuscript:"Manuscript",map:"Image",newspaperArticle:"Newspaper article",patent:"Patent",podcast:"Podcast",presentation:"Presentation",radioBroadcast:"Radio broadcast",report:"Report",statute:"Legislation",thesis:"Thesis",tvBroadcast:"TV broadcast",videoRecording:"Recording",webpage:"Webpage"},addExtensionCSS(){let e=document.createElement("style");e.textContent=`ul.zotero-search-results-list::before{content:attr(aria-label);}
                                            li.autoComplete_selected{background-color:#e7f3f7;}
                                            span.autoComplete_highlighted{color:#146cb7;}
                                            .zotero-roam-citations-search-overlay .bp3-dialog-header{justify-content:flex-end;}
                                            #zotero-roam-citations-pagination > .bp3-button-group{margin:5px 0;}
                                            .zotero-search-item-title{font-weight:600;}
                                            .zotero-search-item-tags{font-style:italic;color:#c1c0c0;display:block;}
                                            .zotero-roam-citation-link{padding: 0 5px;}
                                            .zotero-roam-citation-link a, .zotero-search-item-citation-metadata{font-size:0.85em;}
                                            .zotero-roam-citations-results-count{padding: 6px 10px;}
                                            .zotero-roam-citations-search_result[in-library="true"]{background-color:#e9f7e9;}
                                            .zotero-roam-page-control > span[icon]{margin-right:0px;}
                                            .selected-item-header, .selected-item-body{display:flex;justify-content:space-around;}
                                            .selected-item-header{margin-bottom:20px;}
                                            .selected-item-body{flex-wrap:wrap;}
                                            .item-basic-metadata, .item-additional-metadata{flex: 0 1 60%;}
                                            .item-rendered-notes{flex: 0 1 95%;margin-top:25px;}
                                            .item-citekey, .item-actions{flex:0 1 30%;}
                                            .item-citekey{margin:10px 0px;}
                                            .item-citekey .copy-buttons .bp3-button{font-size:0.7em;flex-wrap:wrap;}
                                            span.zotero-roam-sequence{background-color:khaki;padding:3px 6px;border-radius:3px;font-size:0.85em;font-weight:normal;}
                                            .zotero-roam-tribute {max-width:800px;max-height:300px;overflow:scroll;margin-top:5px;}
                                            .zotero-roam-tribute ul {list-style-type:none;padding:0px;background-color: white;border:1px #e4e4e4 solid; border-radius:2px;}
                                            .zotero-roam-tribute ul li {padding: 2px 5px;font-weight:300;}
                                            .zotero-roam-tribute-selected {background-color: #4f97d4;color:white;}
                                            .zotero-roam-page-div{display:flex;justify-content:space-between;border:1px #eaeaea solid;padding:10px;border-radius:5px;background-color: #f8f8f9;}
                                            .zotero-roam-page-menu{padding-bottom:15px;flex: 0 1 75%;display:block;}
                                            .zotero-roam-page-menu hr{margin:2px 0;}
                                            .scite-badge{padding-top:5px;}
                                            .scite-badge[style*='position: fixed; right: 1%;'] {display: none!important;}
                                            .zotero-roam-page-menu-pdf-link a {color:black;font-weight:600;}
                                            .zotero-roam-page-menu-backlinks-list{list-style-type:none;}
                                            .zotero-roam-page-menu-backlinks-item button{padding:0px;min-height:10px;}
                                            .zotero-roam-page-menu-backlinks-total {font-weight: 700;}
                                            .zotero-roam-citations-search_result > .bp3-menu-item, .zotero-search_result > .bp3-menu-item {flex-wrap:wrap;justify-content:space-between;}
                                            .zotero-roam-citations-search_result > .bp3-menu-item:hover{background-color:unset;cursor:unset;}
                                            .zotero-roam-citation-metadata, .zotero-search-item-contents{flex: 0 2 77%;white-space:normal;}
                                            .zotero-roam-citation-links-list{display:block;}
                                            .zotero-search-item-key{flex: 0 1 20%;text-align:right;}
                                            .zotero-search-item-key .zotero-roam-citation-doi-link {display:block;font-weight:500;}
                                            .zotero-search-item-key a, .zotero-search-item-key button{font-size:0.8em;}
                                            .zotero-roam-citation-abstract{font-size:0.88em;font-weight:300;color:black;padding:3px 5px;flex:0 1 100%;background-color:#edf7ff;}`,document.head.append(e)}};var e=document.createElement("script");e.src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@8.3.2/dist/js/autoComplete.js",e.type="text/javascript",document.getElementsByTagName("head")[0].appendChild(e),void 0===window.Tribute&&((t=document.createElement("script")).src="https://cdn.jsdelivr.net/npm/tributejs@5.1.3",t.type="text/javascript",document.getElementsByTagName("head")[0].appendChild(t));var t=document.createElement("script");t.src="https://cdn.scite.ai/badge/scite-badge-latest.min.js",t.type="application/javascript",t.async=!0,document.getElementsByTagName("head")[0].appendChild(t)})(),zoteroRoam.utils={addBlock(e,t,o=0){window.roamAlphaAPI.createBlock({location:{"parent-uid":e,order:o},block:{string:t}})},executeFunctionByName(e,t){for(var o=Array.prototype.slice.call(arguments,2),a=e.split("."),r=a.pop(),i=0;i<a.length;i++)t=t[a[i]];return t[r].apply(t,o)},formatBib(e){e=e.match('csl-entry">(.+)</div>')[1];let t=document.createElement("textarea");t.innerHTML=e;let o=t.innerText;o=o.replaceAll(/<\/?i>/g,"__");return o=o.replaceAll(/<a href="(.+)">(.+)<\/a>/g,"[$2]($1)"),o},formatItemNotes(e,{split_char:o="\n"}={}){return 0!=e.length&&e.map(e=>{let t=e.data.note.split(o);return t.map(e=>zoteroRoam.utils.parseNoteBlock(e)).filter(e=>e.trim())})},formatItemReference(t,o){switch(o){case"tag":return`#[[@${t.key}]]`;case"pageref":return`[[@${t.key}]]`;case"citation":let e=t.meta.creatorSummary||"";return e=t.meta.parsedDate?`${e} (${new Date(t.meta.parsedDate).getUTCFullYear()})`:e,e=`[${0<e.length?e:t.key}]([[@${t.key}]])`,e;case"zettlr":return(t.meta.creatorSummary||"")+(t.meta.parsedDate?` (${new Date(t.meta.parsedDate).getUTCFullYear()})`:"")+" : "+t.data.title;case"zettlr_accent":return"<strong>"+(t.meta.creatorSummary||"")+(t.meta.parsedDate?` (${new Date(t.meta.parsedDate).getUTCFullYear()})`:"")+"</strong>"+" : "+t.data.title;case"citekey":default:return`@${t.key}`}},getTopBlockData(e){var t=window.roamAlphaAPI.q("[:find ?bUID ?bText :in $ ?pUID :where[?b :block/uid ?bUID][?b :block/string ?bText][?b :block/order 0][?p :block/children ?b][?p :block/uid ?pUID]]",e);if(void 0===t||null==t||0==t.length)return!1;try{return{uid:t[0][0],text:t[0][1]}}catch(e){console.error(e)}},lookForPage(e){let t=null;e=window.roamAlphaAPI.q("[:find ?uid :in $ ?title :where[?p :block/uid ?uid][?p :node/title ?title]]",e);return t=0<e.length?{present:!0,uid:e[0][0]}:{present:!1},t},makeDNP(e,{brackets:t=!0}={}){e=`${["January","February","March","April","May","June","July","August","September","October","November","December"][(e=e.constructor!==Date?new Date(e):e).getMonth()]} ${zoteroRoam.utils.makeOrdinal(e.getDate())}, ${e.getFullYear()}`;return t?`[[${e}]]`:e},makeOrdinal(e){var t=e%10;return 1==t&11!=e?e+"st":2==t&12!=e?e+"nd":3==t&13!=e?e+"rd":e+"th"},makeLinkToPDF(e){return["linked_file","imported_file","imported_url"].includes(e.data.linkMode)?`[${e.data.filename||e.data.title}](zotero://open-pdf/library/items/${e.data.key})`:`[${e.data.title}](${e.data.url})`},makePDFLinks(e){return e.constructor===Array&&0<e.length?e.map(e=>zoteroRoam.utils.makeLinkToPDF(e)):e.constructor===Object&&zoteroRoam.utils.makeLinkToPDF(e)},multiwordMatch(e,t){var o=e.toLowerCase().split(" ");let a=t.toLowerCase(),r=!1;for(let e=0;e<o.length;e++){if(!a.includes(o[e])){r=!1;break}r=!0,a=a.replace(o[e],"")}if(r)return t},addToSidebar(e,t="outline"){window.roamAlphaAPI.ui.rightSidebar.addWindow({window:{type:t,"block-uid":e}})},parseDOI(e){return e.startsWith("10")?e:e.match(/10\.([0-9]+?)\/(.+)/g)[0]},parseNoteBlock(e){let t=e;var o={"</p>":"","</div>":"","<blockquote>":"> ","</blockquote>":"","<strong>":"**","</strong>":"**","<em>":"__","</em>":"__","<b>":"**","</b>":"**","<br />":"\n","<br>":"\n","<u>":"","</u>":""};for(prop in o)t=t.replaceAll(`${prop}`,`${o[prop]}`);["p","div","span","h1","h2","h3"].forEach(e=>{e=new RegExp(`<${e}>|<${e} .+?>`,"g");t=t.replaceAll(e,"")});return t=t.replaceAll(/<a href="(.+?)">(.+?)<\/a>/g,"[$2]($1)"),t},renderBP3Button_group(e,{buttonClass:t="",icon:o="",modifier:a="",buttonAttribute:r=""}={}){return`
            <button type="button" class="bp3-button ${t}" ${r}>
            ${o?`<span icon="${o}" class="bp3-icon bp3-icon-${o} ${a}"></span>`:""}
            <span class="bp3-button-text">${e}</span>
            </button>
            `},renderBP3ButtonGroup(e,{divClass:t="bp3-minimal bp3-fill bp3-align-left",buttonClass:o="",modifier:a="",icon:r="",buttonModifier:i=""}={}){return`<div class="bp3-button-group ${t}">
                        ${zoteroRoam.utils.renderBP3Button_group(e,{buttonClass:o,icon:r,modifier:a,buttonAttribute:i})}
                    </div>`},renderBP3Tag(e,{modifier:t="",icon:o="",tagRemove:a=!1}={}){a=a?'<button class="bp3-tag-remove"></button>':"";return 0<o.length?`<span class="bp3-tag bp3-minimal ${t}"><span icon="${o}" class="bp3-icon bp3-icon-${o}"></span><span class="bp3-text-overflow-ellipsis bp3-fill">${e}</span>${a}</span>`:`<span class="bp3-tag bp3-minimal ${t}" style="margin:5px;">${e}${a}</span>`},renderBP3Toast(e,{toastClass:t="",style:o="opacity:0;transition: opacity 0.3s ease-in;"}={}){return`
            <div class="bp3-toast ${t} bp3-overlay-content" tabindex="0" style="${o}">
            <span class="bp3-toast-message">${e}</span>
            ${zoteroRoam.utils.renderBP3ButtonGroup(e,{divClass:"bp3-minimal",buttonClass:"zotero-roam-toast-close bp3-button bp3-minimal",icon:"small-cross"})}
            </div>
            `},renderHTMLBlockObject(e){let t="";if(void 0===e.string)throw alert("Some of the input was passed as an Object but without a string property. See console for more details"),console.log(e),new Error("All blocks passed as an Object must have a string property");return t+=`<li>${e.string}`,void 0!==e.children&&0<e.children.length&&(t+=zoteroRoam.utils.renderHTMLMetadataArray(e.children)),t+=" </li>",t},renderHTMLMetadataArray(e){let t="<ul>";return e.forEach(e=>{if(e.constructor===Object)t+=zoteroRoam.utils.renderHTMLBlockObject(e);else{if(e.constructor!==String)throw alert("Some of the input was of the wrong type. See the console for more details"),console.log(e),new Error("All array items should be of type String or Object");t+=`<li>${e} </li>`}}),t+="</ul>",t},renderPageReference(e,t){return`<span data-link-title="${e}" data-link-uid="${t}">
            <span tabindex="-1" class="rm-page-ref rm-page-ref--link">${e}</span></span>`},renderPageTag(e){return`<span tabindex="-1" data-tag="${e}" class="rm-page-ref rm-page-ref--tag">#${e}</span>`},setNativeValue(e,t){const o=Object.getOwnPropertyDescriptor(e,"value").set;var a=Object.getPrototypeOf(e);const r=Object.getOwnPropertyDescriptor(a,"value").set;(o&&o!==r?o:r).call(e,t)},sleep(t){return new Promise(e=>setTimeout(e,t))}},zoteroRoam.handlers={async addBlockObject(e,t){if(void 0===t.string)throw console.log(t),new Error("All blocks passed as an Object must have a string property");if(zoteroRoam.utils.addBlock(uid=e,blockString=t.string,order=0),void 0!==t.children){var o=await zoteroRoam.handlers.waitForBlockUID(e,t.string);for(let e=t.children.length-1;0<=e;e--)if(t.children[e].constructor===Object)await zoteroRoam.handlers.addBlockObject(o,t.children[e]);else{if(t.children[e].constructor!==String)throw new Error("All children array items should be of type String or Object");zoteroRoam.utils.addBlock(uid=o,blockString=t.children[e],order=0)}}},async addItemData(e){try{var t=e.parentElement.dataset.linkTitle.replace("@",""),o=e.parentElement.dataset.linkUid,a=zoteroRoam.data.items.find(e=>e.key==t);!a||0<(a=await zoteroRoam.handlers.formatData(a)).length&&await zoteroRoam.handlers.addMetadataArray(page_uid=o,arr=a)}catch(e){console.error(e)}},async addMetadataArray(e,t){if(0<t.length){for(k=t.length-1;0<=k;k--)if(t[k].constructor===Object)await zoteroRoam.handlers.addBlockObject(e,t[k]);else{if(t[k].constructor!==String)throw console.log(t[k]),new Error("All array items should be of type String or Object");zoteroRoam.utils.addBlock(uid=e,blockString=t[k],order=0)}return{success:!0}}return console.log("The metadata array was empty ; nothing was done."),{success:!1}},async addSearchResult(t,o,{popup:a=!0}={}){var r=t.replace("@",""),e=zoteroRoam.data.items.find(e=>e.key==r),i=await zoteroRoam.handlers.formatData(e);let n={};if(e&&0<i.length){var s;if(o)n=await zoteroRoam.handlers.addMetadataArray(page_uid=o,arr=i);else if(window.roamAlphaAPI.createPage({page:{title:t}}),null!=(s=await zoteroRoam.handlers.waitForPageUID(t))){n=await zoteroRoam.handlers.addMetadataArray(page_uid=s,arr=i);try{let e=document.querySelector(".item-in-graph");null!=e&&(e.innerHTML='<span class="bp3-icon-tick bp3-icon bp3-intent-success"></span><span> In the graph</span>');let t=document.querySelector(".item-go-to-page");null!=t&&(t.setAttribute("data-uid",s),t.disabled=!1)}catch(e){}await zoteroRoam.utils.sleep(125)}else console.log(s),alert("There was a problem in obtaining the page's UID.");t=n.success?"Metadata was successfully added.":"The metadata array couldn't be properly processed.";let e=n.success?"success":"danger";1==a?zoteroRoam.interface.popToaster(message=t,e):console.log(t)}else console.log(e),console.log(i),zoteroRoam.interface.popToaster(message="Something went wrong when formatting or importing the item's data.",intent="danger")},async addItemNotes(o,a){var t=o.startsWith("@")?o.slice(1):o,r=zoteroRoam.data.items.find(e=>e.key==t);try{let e=zoteroRoam.formatting.getItemChildren(r,{pdf_as:"raw",notes_as:"formatted",split_char:"\n"});var i=e.notes.flat(1);let t={};var n;if(a)t=await zoteroRoam.handlers.addMetadataArray(page_uid=a,arr=i);else if(window.roamAlphaAPI.createPage({page:{title:o}}),null!=(n=await zoteroRoam.handlers.waitForPageUID(o))){t=await zoteroRoam.handlers.addMetadataArray(page_uid=n,arr=i);try{let e=document.querySelector(".item-in-graph");null!=e&&(e.innerHTML='<span class="bp3-icon-tick bp3-icon bp3-intent-success"></span><span> In the graph</span>');let t=document.querySelector(".item-go-to-page");null!=t&&(t.setAttribute("data-uid",n),t.disabled=!1)}catch(e){}await zoteroRoam.utils.sleep(125)}else console.log(n),alert("There was a problem in obtaining the page's UID.")}catch(e){console.error(e),console.log(r),console.log(itemChildren)}},extractCitekeys(e){return e.map(e=>(void 0!==e.data.extra&&e.data.extra.includes("Citation Key: ")&&(e.key=e.data.extra.match("Citation Key: (.+)")[1]),e))},async fetchData(r,n,t){var o=`https://api.zotero.org/${n}?${t}`;let s=[];try{let e=await fetch(o,{method:"GET",headers:{"Zotero-API-Version":3,"Zotero-API-Key":r}});if(1==e.ok){var l=e.headers.get("Total-Results");let a=new URLSearchParams(t);var c=a.has("start")?Number(a.get("start")):0,d=a.has("limit")?Number(a.get("limit")):100;s=await e.json();var m=c+s.length;if(m<l){var u=Math.ceil((l-m)/d);let e=[];for(i=1;i<=u;i++){var p=m+d*(i-1);a.set("start",p),a.set("limit",d),e.push(fetch(`https://api.zotero.org/${n}?${a.toString()}`,{method:"GET",headers:{"Zotero-API-Version":3,"Zotero-API-Key":r}}))}let t=await Promise.all(e),o=await Promise.all(t.map(e=>e.json()));o=o.flat(1),s.push(...o)}}else console.log(`The request for ${e.url} returned a code of ${e.status}`)}catch(e){console.error(e),alert("The extension encountered at least one error during the data request process. Please check the console for details on the problem.")}finally{return{data:s}}},async formatData(e){var t=e.data.itemType;let o=zoteroRoam.funcmap.DEFAULT;zoteroRoam.config.userSettings.funcmap&&(o=zoteroRoam.config.userSettings.funcmap[`${t}`]||zoteroRoam.config.userSettings.funcmap.DEFAULT||o);try{return await zoteroRoam.utils.executeFunctionByName(o,window,e)}catch(e){return console.error(e),console.log(`There was a problem when formatting the item with function ${o}`),[]}},setupUserRequests(){if(!zoteroRoam.config.userSettings.dataRequests)throw new Error("At least one data request object needs to be specified in order to use the extension. Read through the docs for basic setup examples.");{let e=zoteroRoam.config.userSettings.dataRequests;e=e.constructor===Array?e:[e];var r=e.find(e=>void 0!==e.apikey).apikey,i=e.find(e=>void 0!==e.params).params;e=e.map((e,t)=>{var{name:o=`${t}`,apikey:a=r,dataURI:e,params:t=i}=e;return{apikey:a,dataURI:e,params:t,name:o}}),zoteroRoam.config.requests=e}},async requestScitations(t){var o=zoteroRoam.data.scite.findIndex(e=>e.doi==t);if(-1!=o)return zoteroRoam.data.scite[o];{let e=await fetch(`https://api.scite.ai/papers/sources/${t}`);o=await e.json(),o=Object.values(o.papers);let a={doi:t,citations:o||[]};return a.citations.forEach((e,t)=>{let o=zoteroRoam.data.items.filter(e=>e.data.DOI).map(e=>zoteroRoam.utils.parseDOI(e.data.DOI));o.includes(e.doi)&&(a.citations[t].inLibrary=!0)}),a.simplified=zoteroRoam.handlers.simplifyCitationsObject(a.citations),a.keywords=zoteroRoam.handlers.getCitationsKeywordsCounts(a.citations),zoteroRoam.data.scite.push(a),a}},async requestData(r){if(0==r.length)throw new Error("No data requests were added to the config object - check for upstream problems");try{let o=[],a=[];r.forEach(e=>{var t=e.dataURI.match(/(users|groups)\/(.+?)\//g)[0].slice(0,-1);o.push(zoteroRoam.handlers.fetchData(apiKey=e.apikey,dataURI=e.dataURI,params=e.params)),a.push(fetch(`https://api.zotero.org/${t}/collections`,{method:"GET",headers:{"Zotero-API-Version":3,"Zotero-API-Key":e.apikey}}))});let e=await Promise.all(o);e=e.map((e,t)=>e.data.map(e=>(e.requestLabel=r[t].name,e.requestIndex=t,e))).flat(1),e=zoteroRoam.handlers.extractCitekeys(e);let t=await Promise.all(a);return t=await Promise.all(t.map(e=>e.json())),t=t.flat(1),{success:!0,data:{items:e,collections:t}}}catch(e){return console.error(e),{success:!1}}},async requestItemBib(e,{include:t="bib",style:o,linkwrap:a,locale:r}={}){var i="user"==e.library.type?"users":"groups",n=zoteroRoam.config.requests[`${e.requestIndex}`].apikey;let s=await fetch(`https://api.zotero.org/${i}/${e.library.id}/items/${e.data.key}?include=${t}&style=${o}&linkwrap=${a}&locale=${r}`,{method:"GET",headers:{"Zotero-API-Version":3,"Zotero-API-Key":n}});return(await s.json())[`${t}`]},async requestItemChildren(e){var t=zoteroRoam.config.requests[`${e.requestIndex}`].apikey;let o=await fetch(`${e.links.self.href}/children`,{method:"GET",headers:{"Zotero-API-Version":3,"Zotero-API-Key":t}});return await o.json()},simplifyDataArray(e){let t=e.filter(e=>!["attachment","note","annotation"].includes(e.data.itemType));return t=t.map(e=>{let t={key:e.key,itemKey:e.data.key,title:`${e.data.title||""}`,abstract:`${e.data.abstractNote||""}`,authors:`${e.meta.creatorSummary||""}`,year:`${e.meta.parsedDate?new Date(e.meta.parsedDate).getUTCFullYear().toString():""}`,meta:"",tags:e.data.tags.map(e=>e.tag),authorsFull:e.data.creators.map(e=>e.name||[e.firstName,e.lastName].filter(Boolean).join(" ")),authorsRoles:e.data.creators.map(e=>e.creatorType),authorsLastNames:e.data.creators.map(e=>e.lastName),tagsString:e.data.tags.map(e=>`#${e.tag}`).join(", ")};var o=[e.data.publicationTitle,e.data.university,e.data.bookTitle].filter(Boolean);return 0<o.length&&(t.meta+=`, ${o[0]}`),e.data.publisher&&(t.meta+=`, ${e.data.publisher}`,e.data.place&&(t.meta+=`: ${e.data.place}`)),e.data.volume&&(t.meta+=`, ${e.data.volume}`,e.data.issue&&(t.meta+=`(${e.data.issue})`)),t.meta=e.data.pages?t.meta+`, ${e.data.pages}.`:".",t._multiField=t.authorsLastNames+" "+t.year+" "+t.title+" "+t.tagsString,t}),t},simplifyCitationsObject(e){return 0<e.length?e.map(e=>{let t={abstract:e.abstract||"",doi:e.doi||"",keywords:e.keywords||[],links:{scite:`https://scite.ai/reports/${e.slug}`},title:e.title,year:e.year||"",meta:""},o=0<e.authors.length?e.authors.map(e=>e.family):[];return t.authorsLastNames=0<e.authors.length?e.authors.map(e=>e.family):[],o=0<o.length?2<o.length?o.slice(0,1).join(", ")+" et al.":o.map((e,t)=>0==t?e:t<o.length-1?`, ${e}`:` and ${e}`).join(""):"",t.authors=o,t.meta=`${e.journal||e.publisher}${e.volume?", "+e.volume+"("+e.issue+")":""}${e.page?", "+e.page+".":"."}`,e.inLibrary&&(t.inLibrary=!0),t.links.connectedPapers=`https://www.connectedpapers.com/${e.doi?"api/redirect/doi/"+e.doi:"search?q="+encodeURIComponent(e.title)}`,e.doi&&(t.links.semanticScholar=`https://api.semanticscholar.org/${e.doi}`),t.links.googleScholar=`https://scholar.google.com/scholar?q=${e.doi||encodeURIComponent(e.title)}`,t}):[]},getCitationsKeywordsCounts(o){if(0<o.length){let e=o.map(e=>e.keywords?e.keywords.map(e=>e.toLowerCase()):[]).flat(1),t=[];for(var a=0;a<e.length;a++){var r=e[a];t.push({keyword:r,count:e.filter(e=>e==r).length}),e=e.filter(e=>e!=r)}return t.sort((e,t)=>e.count<t.count?1:-1)}return[]},getLibItems(t="citekey",o="citekey"){return zoteroRoam.data.items.filter(e=>!["attachment","note","annotation"].includes(e.data.itemType)).map(e=>({key:e.key,value:zoteroRoam.utils.formatItemReference(e,t)||e.key,display:zoteroRoam.utils.formatItemReference(e,o)}))},async waitForBlockUID(e,t){let o=null,a=!1,r=0;try{do{if(o=zoteroRoam.utils.getTopBlockData(e),void 0!==o.text&&o.text==t)return a=!0,o.uid}while(r+=1,await zoteroRoam.utils.sleep(75),r<50&&!a);throw console.log(o),new Error("The top block couldn't be matched")}catch(e){console.error(e)}},async waitForPageUID(e){let t=!1,o=0;do{var a=zoteroRoam.utils.lookForPage(e);if(1==a.present)return t=!0,a.uid}while(o+=1,await zoteroRoam.utils.sleep(75),o<50&&!t);throw new Error(`The page with title "${e}" couldn\'t be found`)}},zoteroRoam.interface={icon:null,portal:{div:null,id:"zotero-data-importer-portal"},contextMenu:{div:null,class:"zotero-context-menu",overlay:{div:null,class:"zotero-context-overlay"},options:{list:[],class:"zotero-context-menu-option",labels:["Import Zotero data to page","Convert to citation"]},visible:!1,targetElement:null,position({top:e,left:t}){zoteroRoam.interface.contextMenu.div.style.left=`${t}px`,zoteroRoam.interface.contextMenu.div.style.top=`${e}px`,zoteroRoam.interface.toggleContextOverlay("contextMenu","show")}},iconContextMenu:{div:null,class:"zotero-icon-context-menu",overlay:{div:null,class:"zotero-icon-context-overlay"},options:{list:[],class:"zotero-icon-context-menu-option",labels:["Update Zotero data","Search in dataset..."]},visible:!1,position({top:e,left:t}){zoteroRoam.interface.iconContextMenu.div.style.left=t>=.9*window.innerWidth?`calc(${t}px - 10%)`:`${t}px`,zoteroRoam.interface.iconContextMenu.div.style.top=`calc(${e}px + 3%)`,zoteroRoam.interface.toggleContextOverlay("iconContextMenu","show")}},citations:{overlay:null,input:null,closeButton:null,overlayClass:"zotero-roam-citations-search"},search:{overlay:null,input:null,selectedItemDiv:null,closeButton:null,updateButton:null,overlayClass:"zotero-search"},tributeTrigger:"",tributeBlockTrigger:null,tributeNewText:"",create(){zoteroRoam.interface.createIcon(id="zotero-data-icon"),zoteroRoam.interface.portal.div=zoteroRoam.interface.createPortal(id=zoteroRoam.interface.portal.id),zoteroRoam.interface.createContextMenu(elementKey="contextMenu"),zoteroRoam.interface.createContextMenu(elementKey="iconContextMenu"),zoteroRoam.interface.createOverlay(divClass=zoteroRoam.interface.search.overlayClass),zoteroRoam.interface.fillSearchOverlay(),zoteroRoam.interface.createOverlay(divClass=zoteroRoam.interface.citations.overlayClass),zoteroRoam.interface.fillCitationsOverlay(),zoteroRoam.interface.createToasterOverlay()},setup(){zoteroRoam.interface.icon.addEventListener("click",zoteroRoam.extension.toggle),zoteroRoam.interface.setupContextMenus(["contextMenu","iconContextMenu"]),zoteroRoam.interface.search.updateButton.addEventListener("click",zoteroRoam.extension.update),zoteroRoam.interface.search.closeButton.addEventListener("click",function(){zoteroRoam.interface.toggleSearchOverlay("hide")}),zoteroRoam.interface.search.input.addEventListener("rendered",zoteroRoam.interface.renderNbResults)},createIcon(e){try{document.getElementById(e).closest(".bp3-popover-wrapper").remove()}catch(e){}var t=document.createElement("span");t.classList.add("bp3-popover-wrapper"),t.setAttribute("style","margin-left: 4px;"),t.innerHTML=`<span class="bp3-popover-target"><span id="${e}" status="off" class="bp3-button bp3-icon-manual bp3-minimal bp3-small"></span>`,document.querySelector(".rm-topbar").appendChild(t),zoteroRoam.interface.icon=document.getElementById(e)},createPortal(e){try{document.getElementById(e).remove()}catch(e){}var t=document.createElement("div");return t.classList.add("bp3-portal"),t.id=e,document.getElementById("app").appendChild(t),t},createContextMenu(e){let t=zoteroRoam.interface[`${e}`];try{document.querySelector(`.${t.overlay.class}`).remove()}catch(e){}var o=t.options.labels.map(e=>`<li class="${t.options.class}"><a class="bp3-menu-item bp3-popover-dismiss"><div class="bp3-fill bp3-text-overflow-ellipsis">${e}</div></a></li>`).join(""),a=document.createElement("div");a.classList.add("bp3-overlay"),a.classList.add("bp3-overlay-open"),a.classList.add(`${t.overlay.class}`),a.style="display:none;",a.innerHTML=`<div class="bp3-overlay-backdrop bp3-popover-backdrop bp3-popover-appear-done bp3-popover-enter-done" style="z-index:25;"></div>
                                    <div class="bp3-transition-container bp3-popover-appear-done bp3-popover-enter-done ${t.class}" style="width: auto; position: fixed;z-index:25;">
                                        <div class="bp3-popover bp3-minimal">
                                            <div class="bp3-popover-content">
                                                <div>
                                                    <ul class="bp3-menu bp3-text-small">
                                                        ${o}
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>`,zoteroRoam.interface.portal.div.appendChild(a),zoteroRoam.interface[`${e}`].overlay.div=document.querySelector(`.${zoteroRoam.interface[`${e}`].overlay.class}`),zoteroRoam.interface[`${e}`].div=document.querySelector(`.${zoteroRoam.interface[`${e}`].class}`),zoteroRoam.interface[`${e}`].options.list=document.querySelectorAll(`.${zoteroRoam.interface[`${e}`].options.class}`)},createToasterOverlay(){let e=document.createElement("div");e.classList.add("bp3-overlay"),e.classList.add("bp3-overlay-open"),e.classList.add("bp3-toast-container"),e.classList.add("bp3-toast-container-top"),e.classList.add("bp3-toast-container-in-portal"),e.classList.add("zotero-roam-toaster-overlay"),zoteroRoam.interface.portal.div.appendChild(e)},async popToaster(e,t="primary"){let o=zoteroRoam.interface.portal.div.querySelector(".zotero-roam-toaster-overlay");o.innerHTML=zoteroRoam.utils.renderBP3Toaster(string=e,{toastClass:`bp3-intent-${t}`}),o.querySelector(".bp3-toast").style.opacity="1",await zoteroRoam.utils.sleep(500),o.querySelector(".bp3-toaster").style.opacity="0"},createOverlay(t,e="width:60%;align-self:baseline;",o=!0){try{document.querySelector(`.${t}-overlay`).remove()}catch(e){}let o=document.createElement("div");if(o.classList.add("bp3-overlay"),o.classList.add("bp3-overlay-open"),o.classList.add("bp3-overlay-scroll-container"),o.classList.add(`${t}-overlay`),o.setAttribute("overlay-visible","false"),o.style="display:none;",o){let e=document.createElement("div");e.classList.add("bp3-overlay-backdrop"),e.classList.add("bp3-overlay-appear-done"),e.classList.add("bp3-overlay-enter-done"),e.classList.add(`${t}-backdrop`),e.tabIndex="0",o.appendChild(e)}let a=document.createElement("div");a.classList.add("bp3-dialog-container"),a.classList.add("bp3-overlay-content"),a.classList.add("bp3-overlay-appear-done"),a.classList.add("bp3-overlay-enter-done"),a.tabIndex="0";let r=document.createElement("div");r.classList.add("bp3-dialog"),r.style=e;let i=document.createElement("div");i.classList.add("bp3-dialog-header");let n=document.createElement("div");n.classList.add("bp3-dialog-body");let s=document.createElement("div");s.classList.add("bp3-dialog-footer"),i.innerHTML=`<button type="button" aria-label="Close" class="zotero-search-close bp3-button bp3-minimal bp3-dialog-close-button">
                                            <span icon="small-cross" class="bp3-icon bp3-icon-small-cross"></span></button>`,r.appendChild(i),r.appendChild(n),r.appendChild(s),a.appendChild(r),o.appendChild(a),zoteroRoam.interface.portal.div.appendChild(o)},fillSearchOverlay(e=zoteroRoam.interface.search.overlayClass){let t=document.querySelector(`.${e}-overlay .bp3-dialog-header`),o=document.querySelector(`.${e}-overlay .bp3-dialog-body`),a=document.querySelector(`.${e}-overlay .bp3-dialog-footer`);t.innerHTML=`<label class="bp3-control bp3-switch" style="margin-bottom:0px;flex: 1 1 auto;">
            <input id="zotero-quick-copy-mode" type="checkbox"><span class="bp3-control-indicator"></span>Quick Copy</label>`+t.innerHTML;let r=document.createElement("p");r.innerHTML=`<strong>Enter text below to look for items* in your loaded Zotero dataset.</strong>
                            <br>(* searchable fields are : title, year, authors, tags, citekey. A more fully-featured search will be available down the road)`,o.appendChild(r);let i=document.createElement("div");i.classList.add("bp3-input-group");let n=document.createElement("input");n.id="zotero-search-autocomplete",n.tabIndex="1",n.type="text",n.classList.add("bp3-input"),n.classList.add("bp3-fill"),n.style="margin-bottom:20px;",i.appendChild(n),o.appendChild(i);let s=document.createElement("div");s.id="zotero-search-selected-item",s.classList.add("bp3-card"),s.style="width:95%;margin:0 auto;display:none;";let l=document.createElement("div");l.classList.add("selected-item-header");let c=document.createElement("div");c.classList.add("selected-item-body"),s.appendChild(l),s.appendChild(c),o.appendChild(s),a.innerHTML=`<div class="bp3-dialog-footer-actions">
                                            <input class="bp3-input clipboard-copy-utility" type="text" readonly style="opacity:0;">
                                            <span class="bp3-popover2-target" tabindex="0">
                                                <button type="button" class="zotero-update-data bp3-button">
                                            <span class="bp3-button-text">Update Zotero data</span>
                                            </button></span></div>`,zoteroRoam.interface.search.overlay=document.querySelector(`.${e}-overlay`),zoteroRoam.interface.search.input=document.querySelector("#zotero-search-autocomplete"),zoteroRoam.interface.search.selectedItemDiv=document.querySelector("#zotero-search-selected-item"),zoteroRoam.interface.search.closeButton=document.querySelector(`.${e}-overlay button.zotero-search-close`),zoteroRoam.interface.search.updateButton=document.querySelector(`.${e}-overlay button.zotero-update-data`)},fillCitationsOverlay(e=zoteroRoam.interface.citations.overlayClass){let t=document.querySelector(`.${e}-overlay .bp3-dialog-body`),o=document.querySelector(`.${e}-overlay .bp3-dialog-footer`),a=document.createElement("div");a.classList.add("bp3-input-group");let r=document.createElement("input");r.id="zotero-roam-citations-autocomplete",r.tabIndex="1",r.type="text",r.classList.add("bp3-input"),r.classList.add("bp3-fill"),a.appendChild(r);let i=document.createElement("div");i.id="zotero-roam-citations-pagination";let n=document.createElement("div");n.classList.add("bp3-button-group"),n.classList.add("bp3-minimal"),n.innerHTML=`
            ${zoteroRoam.utils.renderBP3Button_group(string="",{icon:"chevron-left",buttonClass:"zotero-roam-page-control",buttonAttribute:'goto="previous"'})}
            ${zoteroRoam.utils.renderBP3Button_group(string="",{icon:"chevron-right",buttonClass:"zotero-roam-page-control",buttonAttribute:'goto="next"'})}
            <span class="zotero-roam-citations-results-count"></span>
            `,i.appendChild(n),a.appendChild(i),t.appendChild(a),o.innerHTML=`
            <div class="bp3-dialog-footer-actions">
            <input class="bp3-input clipboard-copy-utility" type="text" readonly style="opacity:0;">
            </div>
            `,zoteroRoam.interface.citations.overlay=document.querySelector(`.${e}-overlay`),zoteroRoam.interface.citations.input=document.querySelector("#zotero-roam-citations-autocomplete"),zoteroRoam.interface.citations.closeButton=document.querySelector(`.${e}-overlay button.zotero-search-close`),Array.from(zoteroRoam.interface.citations.overlay.querySelectorAll(".zotero-roam-page-control")).forEach(t=>{t.addEventListener("click",e=>{zoteroRoam.interface.changePage(goto=t.getAttribute("goto"))})}),zoteroRoam.interface.citations.closeButton.addEventListener("click",zoteroRoam.interface.closeCitationsOverlay)},renderCitationsPagination(){let e=document.querySelector("#zotero-roam-citations-pagination"),t=e.querySelector("ul");null==t&&(t=document.createElement("ul"),t.classList.add("zotero-roam-citations-search-results-list"),t.classList.add("bp3-menu"),t.tabIndex="-1",t.setAttribute("role","listbox"),e.appendChild(t));let o=zoteroRoam.citations.pagination.getCurrentPageData();e.querySelector(".zotero-roam-citations-results-count").innerHTML=`
            <strong>${zoteroRoam.citations.pagination.startIndex}-${zoteroRoam.citations.pagination.startIndex+o.length-1}</strong> / ${zoteroRoam.citations.pagination.data.length} citations
            `,t.innerHTML=o.map(t=>{var o,e=`<span class="zotero-search-item-title" style="display:block;">${t.title} ${t.inLibrary?'<span icon="endorsed" class="bp3-icon bp3-icon-endorsed bp3-intent-success"></span>':""}</span>`,a=t.authors+(t.year?" ("+t.year+")":""),r=`<span class="zotero-search-item-citation-metadata">${zoteroRoam.utils.renderBP3Tag(a,{modifier:"bp3-intent-warning"})} ${t.meta}</span>`;let i="";for(o of Object.keys(t.links)){let e=[];switch(o){case"scite":e.push(`<span class="zotero-roam-citation-link" service="scite"><a href="${t.links[o]}" target="_blank">Scite</a></span>`);break;case"connectedPapers":e.push(`<span class="zotero-roam-citation-link" service="connected-papers"><a href="${t.links[o]}" target="_blank">Connected Papers</a></span>`);break;case"semanticScholar":e.push(`<span class="zotero-roam-citation-link" service="semantic-scholar"><a href="${t.links[o]}" target="_blank">Semantic Scholar</a></span>`);break;case"googleScholar":e.push(`<span class="zotero-roam-citation-link" service="google-scholar"><a href="${t.links[o]}" target="_blank">Google Scholar</a></span>`)}i+=e.join(" &#8226; ")}a=`
                <span class="bp3-menu-item-label zotero-search-item-key">
                <a href="https://doi.org/${t.doi}" class="zotero-roam-citation-doi-link">${t.doi}</a>
                ${t.abstract?zoteroRoam.utils.renderBP3Button_group("Show Abstract",{buttonClass:"zotero-roam-citation-toggle-abstract bp3-minimal"}):""}
                ${zoteroRoam.utils.renderBP3Button_group("Copy DOI",{buttonClass:"zotero-roam-citation-copy-doi bp3-intent-primary bp3-outlined",buttonAttribute:'data-doi="'+t.doi+'"'})}
                </span>
                `;return`
                <li class="zotero-roam-citations-search_result" ${t.inLibrary?'in-library="true"':""}>
                <div class="bp3-menu-item">
                <div class="bp3-text-overflow-ellipsis bp3-fill zotero-roam-citation-metadata">
                ${e}
                ${r}
                <span class="zotero-roam-citation-links-list">
                ${i}
                </span>
                </div>
                ${a}
                <span class="zotero-roam-citation-abstract" style="display:none;">${t.abstract}</span>
                </div></li>
                `}).join("");try{var a=Array.from(e.querySelectorAll("button.zotero-roam-citation-copy-doi"));if(0<a.length)for(const i of a)i.addEventListener("click",function(){zoteroRoam.interface.citations.overlay.querySelector("input.clipboard-copy-utility").value=i.dataset.doi,zoteroRoam.interface.citations.overlay.querySelector("input.clipboard-copy-utility").select(),document.execCommand("copy")})}catch(e){}try{var r=Array.from(e.querySelectorAll("button.zotero-roam-citation-toggle-abstract"));if(0<r.length)for(const n of r)n.addEventListener("click",function(){let e=n.querySelector(".bp3-button-text"),t=n.closest(".zotero-roam-citations-search_result").querySelector(".zotero-roam-citation-abstract");"none"==t.style.display?(t.style.display="block",e.innerHTML="Hide Abstract"):(t.style.display="none",e.innerHTML="Show Abstract")})}catch(e){}},setupContextMenus(t){window.addEventListener("click",e=>{t.forEach(e=>{zoteroRoam.interface[`${e}`].visible&&zoteroRoam.interface.toggleContextOverlay(e,command="hide")})}),t.forEach(o=>{zoteroRoam.interface[`${o}`].options.list.forEach((e,t)=>{switch(zoteroRoam.interface[`${o}`].options.labels[t]){case"Import Zotero data to page":e.addEventListener("click",()=>{zoteroRoam.handlers.addItemData(zoteroRoam.interface.contextMenu.targetElement)});break;case"Convert to citation":e.addEventListener("click",()=>{zoteroRoam.inPage.convertToCitekey(zoteroRoam.interface.contextMenu.targetElement)});break;case"Update Zotero data":e.addEventListener("click",zoteroRoam.extension.update);break;case"Search in dataset...":e.addEventListener("click",function(){zoteroRoam.interface.toggleSearchOverlay("show")})}})})},toggleContextOverlay(e,t){zoteroRoam.interface[`${e}`].overlay.div.style.display="show"==t?"block":"none",zoteroRoam.interface[`${e}`].visible="show"==t},toggleSearchOverlay(e){zoteroRoam.interface.search.overlay.style.display="show"===e?"block":"none","show"==e?(console.log("Opening the Search Panel"),zoteroRoam.interface.search.input.focus(),zoteroRoam.interface.search.input.value="",zoteroRoam.interface.search.overlay.setAttribute("overlay-visible","true")):(console.log("Closing the Search Panel"),zoteroRoam.interface.clearSelectedItem(),zoteroRoam.interface.search.input.value="",zoteroRoam.interface.search.overlay.querySelector("input.clipboard-copy-utility").value="",zoteroRoam.interface.search.overlay.setAttribute("overlay-visible","false"))},changePage(e){if(null!==zoteroRoam.citations.pagination&&0<zoteroRoam.citations.pagination.nbPages)switch(e){case"previous":zoteroRoam.citations.pagination.previousPage();break;case"next":zoteroRoam.citations.pagination.nextPage()}},popCitationsOverlay(t){zoteroRoam.citations.currentDOI=t;var e=zoteroRoam.data.scite.find(e=>e.doi==t).simplified;zoteroRoam.citations.pagination=new zoteroRoam.Pagination({data:e}),zoteroRoam.interface.renderCitationsPagination(),null==zoteroRoam.citations.autocomplete?(zoteroRoam.config.citationsSearch.maxResults=zoteroRoam.data.items.length,zoteroRoam.citations.autocomplete=new autoComplete(zoteroRoam.config.citationsSearch)):zoteroRoam.citations.autocomplete.init(),zoteroRoam.interface.citations.overlay.style.display="block",zoteroRoam.interface.citations.input.value="",zoteroRoam.interface.citations.overlay.querySelector("input.clipboard-copy-utility").value="",zoteroRoam.interface.citations.overlay.setAttribute("overlay-visible","true"),zoteroRoam.interface.citations.input.focus()},closeCitationsOverlay(){zoteroRoam.interface.citations.overlay.style.display="none",zoteroRoam.interface.citations.input.value="",zoteroRoam.interface.citations.overlay.querySelector("input.clipboard-copy-utility").value="",zoteroRoam.interface.citations.overlay.setAttribute("overlay-visible","false")},popContextOverlay(e,t){e.preventDefault();var o={left:e.pageX,top:e.pageY};return zoteroRoam.interface[`${t}`].position(o),"contextMenu"==t&&(zoteroRoam.interface.contextMenu.targetElement=e.target),!1},async popContextMenu(e){zoteroRoam.interface.popContextOverlay(e,"contextMenu"),await zoteroRoam.utils.sleep(200);try{document.querySelector("body > .bp3-context-menu+.bp3-portal").style.display="none"}catch(e){}},popIconContextMenu(e){zoteroRoam.interface.popContextOverlay(e,"iconContextMenu")},renderNbResults(e){let t="";0<e.detail.results.length&&(t=`Showing ${e.detail.results.length} out of ${e.detail.matches.length} results`),document.querySelector("#zotero-search-results-list").setAttribute("aria-label",t)},renderSelectedItem(o){var e=zoteroRoam.data.items.find(e=>e.key==o.selection.value.key),a="@"+o.selection.value.key,t=o.selection.value.year?`(${o.selection.value.year})`:"",r=o.selection.value.authorsFull,n=o.selection.value.authorsRoles;let s="";if(0<r.length)for(i=0;i<r.length;i++){var l=zoteroRoam.utils.lookForPage(title=r[i]),c=1==l.present?zoteroRoam.utils.renderPageReference(title=r[i],uid=l.uid):zoteroRoam.utils.renderBP3Tag(string=r[i],{modifier:"bp3-intent-primary bp3-round"}),l=n[i]&&"author"!=n[i]?` (${n[i]})`:"";s=s+c+l,i<r.length-2?s+=", ":i==r.length-2&&(s+=" & ")}var d=o.selection.value.tags;let m="";if(0<d.length)for(i=0;i<d.length;i++){var u=1==zoteroRoam.utils.lookForPage(title=d[i]).present?zoteroRoam.utils.renderPageTag(title=d[i]):zoteroRoam.utils.renderBP3Tag(string=d[i]);m=m+u+" "}let p=zoteroRoam.formatting.getItemCollections(e),h="";if(p)try{h=p.map(e=>zoteroRoam.utils.renderBP3Tag(string=e.data.name,{modifier:"bp3-intent-success bp3-round",icon:"projects"})).join(" ")}catch(e){console.log(p),console.log(e),console.error("Something went wrong while getting the item's collections data")}var g=zoteroRoam.utils.lookForPage(a),y=1==g.present?"tick":"cross",f=1==g.present?"success":"danger";let b=1==g.present?"In the graph":"Not in the graph";if(1==g.present)try{var z=window.roamAlphaAPI.q("[:find (count ?chld) :in $ ?uid :where[?p :block/uid ?uid][?p :block/children ?chld]]",g.uid)[0][0];b+=` (<b>${z}</b> direct children)`}catch(e){}f=`<div style="padding:0 10px;" class="item-in-graph"><span class="bp3-icon-${y} bp3-icon bp3-intent-${f}"></span><span> ${b}</span></div>`;let v=document.querySelector(".selected-item-header");v.innerHTML=`<div class="item-basic-metadata">
                                        <h4 class="item-title" tabindex="0">${o.selection.value.title}${t}</h4>
                                        <p class="item-metadata-string">${s}${o.selection.value.meta}</p>
                                        </div>
                                    <div class="item-citekey">
                                        <div class="bp3-fill" style="font-weight:bold;padding:0 10px;">${a}</div>
                                        <div class="bp3-button-group bp3-fill bp3-minimal copy-buttons">
                                            <a class="bp3-button bp3-intent-primary" format="citekey">Copy @citekey ${zoteroRoam.shortcuts.sequences.copyCitekey?zoteroRoam.shortcuts.makeSequenceText("copyCitekey"):""}</a>
                                            <a class="bp3-button bp3-intent-primary" format="citation">[Citation]([[@]]) ${zoteroRoam.shortcuts.sequences.copyCitation?zoteroRoam.shortcuts.makeSequenceText("copyCitation"):""}</a>
                                            <a class="bp3-button bp3-intent-primary" format="tag">#@ ${zoteroRoam.shortcuts.sequences.copyTag?zoteroRoam.shortcuts.makeSequenceText("copyTag"):""}</a>
                                            <a class="bp3-button bp3-intent-primary" format="page-reference">[[@]] ${zoteroRoam.shortcuts.sequences.copyPageRef?zoteroRoam.shortcuts.makeSequenceText("copyPageRef"):""}</a>
                                        </div>
                                        ${f}
                                    </div>`;let R=document.querySelector(".selected-item-body");var t=1==g.present?`data-uid="${g.uid}"`:"disabled",f=zoteroRoam.shortcuts.sequences.goToItemPage?zoteroRoam.shortcuts.makeSequenceText("goToItemPage",pre=" "):"",k=`https://roamresearch.com/${window.location.hash.match(/#\/app\/([^\/]+)/g)[0]}/page/${g.uid}`,f=`<a href="${k}">Go to Roam page</a>  ${f}`,f=zoteroRoam.utils.renderBP3ButtonGroup(string=f,{buttonClass:"item-go-to-page",divClass:"bp3-minimal",icon:"arrow-right",modifier:"bp3-intent-primary",buttonModifier:`${t}`}),t=`Import metadata  ${zoteroRoam.shortcuts.sequences.importMetadata?zoteroRoam.shortcuts.makeSequenceText("importMetadata",pre=" "):""}`,t=zoteroRoam.utils.renderBP3ButtonGroup(string=t,{buttonClass:"item-add-metadata",divClass:"bp3-minimal",icon:"add",modifier:"bp3-intent-primary"});let w=zoteroRoam.formatting.getItemChildren(e,{pdf_as:"raw",notes_as:"raw"}),$="";if(w.remoteChildren)$+="<p>This item has children, but they were not returned by the API data request. This might be due to a request for 'items/top' rather than 'items'.</p>";else try{var S=w.pdfItems?w.pdfItems.map(e=>{e=`<a href="${["linked_file","imported_file","imported_url"].includes(e.data.linkMode)?`zotero://open-pdf/library/items/${e.data.key}`:e.data.url}">${e.data.filename||e.data.title}</a>`;return zoteroRoam.utils.renderBP3ButtonGroup(string=e,{icon:"paperclip"})}):"No PDF attachments";$+=S;S=w.notes?zoteroRoam.utils.renderBP3ButtonGroup(string="Show notes below",{buttonClass:"item-see-notes",icon:"comment"}):"";$+=S}catch(e){console.log(w),console.log(pdfDiv),console.log(e),console.log("Something went wrong while getting the item's children data")}R.innerHTML=`<div class="item-additional-metadata">
                                    <p class="item-abstract">${o.selection.value.abstract}</p>
                                    <p class="item-tags">${m}</p>
                                    <p class="item-collections">${h}</p>
                                </div>
                                <div class="item-actions">
                                    ${f}
                                    ${t}
                                    <div class="item-pdf-notes" style="margin-top: 25px;">
                                        <h5>PDFs & Notes</h5>
                                        ${$}
                                    </div>
                                </div>
                                <div class="item-rendered-notes">
                                </div>`;var x=g.uid||"";document.querySelector("button.item-add-metadata").addEventListener("click",function(){console.log("Importing metadata..."),zoteroRoam.handlers.addSearchResult(a,x,{popup:!0})}),document.querySelector("button.item-go-to-page a").addEventListener("click",function(){window.location.href=k,zoteroRoam.interface.toggleSearchOverlay("hide")}),Array.from(document.querySelectorAll(".item-citekey .copy-buttons a.bp3-button[format]")).forEach(t=>{t.addEventListener("click",e=>{switch(t.getAttribute("format")){case"citekey":zoteroRoam.interface.search.overlay.querySelector("input.clipboard-copy-utility").value=`${a}`;break;case"citation":let e=`${o.selection.value.authors}`;o.selection.value.year&&(e+=` (${o.selection.value.year})`),zoteroRoam.interface.search.overlay.querySelector("input.clipboard-copy-utility").value=`[${e}]([[${a}]])`;break;case"tag":zoteroRoam.interface.search.overlay.querySelector("input.clipboard-copy-utility").value=`#[[${a}]]`;break;case"page-reference":zoteroRoam.interface.search.overlay.querySelector("input.clipboard-copy-utility").value=`[[${a}]]`}zoteroRoam.interface.search.overlay.querySelector("input.clipboard-copy-utility").select(),document.execCommand("copy")})});try{document.querySelector("button.item-see-notes").addEventListener("click",function(){document.querySelector("div.item-rendered-notes").innerHTML=`<hr><h4>Notes</h4><br>${w.notes.map(e=>e.data.note).join("<br>")}`})}catch(e){}zoteroRoam.interface.search.selectedItemDiv.style.display="block",document.querySelector("h4.item-title").focus()},clearSelectedItem(){try{zoteroRoam.interface.search.selectedItemDiv.children.forEach(e=>{e.innerHTML=""})}catch(e){Array.from(zoteroRoam.interface.search.selectedItemDiv.children).forEach(e=>{e.innerHTML=""})}zoteroRoam.interface.search.selectedItemDiv.style.display="none"},checkEditingMode(){let e=document.querySelector("textarea.rm-block-input");e&&null==e.getAttribute("zotero-tribute")&&(document.querySelectorAll(".zotero-roam-tribute").forEach(e=>e.remove()),e.setAttribute("zotero-tribute","active"),new Tribute(zoteroRoam.config.tribute).attach(e),e.addEventListener("tribute-replaced",e=>{let t=document.querySelector("textarea.rm-block-input");var o=e.detail.context.mentionTriggerChar+e.detail.context.mentionText,a=e.detail.context.mentionPosition,r=e.detail.item.original.value;let i=e.target.defaultValue;e=new RegExp(o,"g"),e=i.replaceAll(e,(e,t)=>t==a?r:e);zoteroRoam.interface.tributeTrigger=o,zoteroRoam.interface.tributeBlockTrigger=t,zoteroRoam.interface.tributeNewText=e,Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype,"value").set.call(t,e);e=new Event("input",{bubbles:!0});t.dispatchEvent(e)}))}},zoteroRoam.extension={async load(){zoteroRoam.interface.icon.style="background-color: #fd9d0d63!important;";var e=await zoteroRoam.handlers.requestData(zoteroRoam.config.requests);if(!e.success)throw zoteroRoam.interface.icon.style="background-color:#f9a3a3 !important",zoteroRoam.interface.popToaster(message="There was a problem with the Zotero data request. Please check your specification !",intent="danger"),new Error("The API request encountered a problem. Please check your request specification, and the console for any registered errors.");zoteroRoam.data.items=e.data.items,zoteroRoam.data.collections=e.data.collections,zoteroRoam.interface.icon.setAttribute("status","on"),zoteroRoam.inPage.checkReferences(),document.addEventListener("blur",zoteroRoam.inPage.checkReferences,!0),window.addEventListener("locationchange",zoteroRoam.inPage.checkReferences,!0),zoteroRoam.config.ref_checking=setInterval(zoteroRoam.inPage.checkReferences,1e3),zoteroRoam.inPage.addPageMenus(),window.addEventListener("locationchange",zoteroRoam.inPage.addPageMenus,!0),zoteroRoam.config.page_checking=setInterval(zoteroRoam.inPage.addPageMenus,1e3),zoteroRoam.config.userSettings.autoupdate&&(zoteroRoam.config.auto_update=setInterval(function(){zoteroRoam.extension.update(popup=!1)},6e4)),null==zoteroRoam.autoComplete?zoteroRoam.autoComplete=new autoComplete(zoteroRoam.config.autoComplete):zoteroRoam.autoComplete.init(),zoteroRoam.config.autoComplete.trigger.event.forEach(e=>{zoteroRoam.interface.search.input.addEventListener(e,zoteroRoam.interface.clearSelectedItem)}),1==zoteroRoam.config.params.autocomplete.enabled&&(zoteroRoam.config.editingObserver=new MutationObserver(zoteroRoam.interface.checkEditingMode),zoteroRoam.config.editingObserver.observe(document,{childList:!0,subtree:!0})),zoteroRoam.interface.icon.addEventListener("contextmenu",zoteroRoam.interface.popIconContextMenu),window.addEventListener("keyup",zoteroRoam.shortcuts.verify),window.addEventListener("keydown",zoteroRoam.shortcuts.verify),zoteroRoam.interface.icon.style="background-color: #60f06042!important;",zoteroRoam.interface.popToaster(message="Zotero data successfully loaded !",intent="success"),console.log("The results of the API request have been received ; you can check them by inspecting the value of the zoteroRoam.data object. Data import context menu should now be available.")},unload(){zoteroRoam.interface.icon.setAttribute("status","off"),zoteroRoam.data={items:[],collections:[],scite:[]},null!==zoteroRoam.autoComplete&&zoteroRoam.autoComplete.unInit(),null!==zoteroRoam.citations.autocomplete&&zoteroRoam.citations.autocomplete.unInit(),Array.from(document.querySelectorAll(".zotero-roam-page-div")).forEach(e=>e.remove());let e=document.querySelectorAll("ref-citekey");e.forEach(e=>{e.removeAttribute("data-zotero-bib"),e.querySelector(".rm-page-ref").removeEventListener("contextmenu",zoteroRoam.interface.popContextMenu)}),zoteroRoam.interface.icon.removeEventListener("contextmenu",zoteroRoam.interface.popIconContextMenu),document.removeEventListener("blur",zoteroRoam.inPage.checkReferences,!0),window.removeEventListener("locationchange",zoteroRoam.inPage.checkReferences,!0);try{clearInterval(zoteroRoam.config.ref_checking)}catch(e){}try{clearInterval(zoteroRoam.config.page_checking)}catch(e){}try{clearInterval(zoteroRoam.config.auto_update)}catch(e){}zoteroRoam.config.editingObserver.disconnect(),window.removeEventListener("keyup",zoteroRoam.shortcuts.verify),window.removeEventListener("keydown",zoteroRoam.shortcuts.verify),zoteroRoam.interface.icon.removeAttribute("style"),zoteroRoam.interface.popToaster(message="All Zotero data was cleared. Bye for now !",intent="success"),console.log("Data and request outputs have been removed")},toggle(){"off"==zoteroRoam.interface.icon.getAttribute("status")?zoteroRoam.extension.load():zoteroRoam.extension.unload()},async update(t=!0){zoteroRoam.interface.icon.style="background-color: #fd9d0d63!important;";var o=zoteroRoam.config.requests.map(t=>{let e=zoteroRoam.data.items.filter(e=>e.requestLabel==t.name);var o=e.reduce((e,t)=>e.version<t.version?t:e).version,{apikey:a,dataURI:r,params:i,name:n}=t;let s=new URLSearchParams(i);return s.set("since",o),{apikey:a,dataURI:r,params:s.toString(),name:n}}),o=await zoteroRoam.handlers.requestData(o);if(1==o.success){zoteroRoam.data.collections=o.data.collections;let e=o.data.items;if(0==e.length)t&&alert("No new items were found since the data was last loaded. Data on collections was refreshed."),zoteroRoam.interface.icon.style="background-color: #60f06042!important;";else{let o=zoteroRoam.handlers.extractCitekeys(e).length,a=0;e.forEach(t=>{var e=zoteroRoam.data.items.findIndex(e=>e.key==t.key&e.requestLabel==t.requestLabel);-1==e?zoteroRoam.data.items.push(t):(zoteroRoam.data.items[e]=t,a+=1,--o)}),zoteroRoam.inPage.checkCitekeys(update=!0),t?alert(`${o} new items and ${a} modified items were added to the dataset. Data on collections was refreshed.`):console.log(`${o} new items and ${a} modified items were added to the dataset. Data on collections was refreshed.`),zoteroRoam.interface.icon.style="background-color: #60f06042!important;"}}else t?alert("Something went wrong when updating the data. Check the console for any errors."):console.log("Something went wrong when updating the data. Check the console for any errors.")}},zoteroRoam.inPage={addContextMenuListener(){for(var e=document.querySelectorAll(".ref-citekey"),t=0;t<e.length;t++){var o=e[t];o.dataset.zoteroBib||(zoteroRoam.data.items.find(e=>e.key==o.dataset.linkTitle.replace("@",""))?o.dataset.zoteroBib="inLibrary":o.dataset.zoteroBib="notFound"),"inLibrary"==o.dataset.zoteroBib&&o.querySelector(".rm-page-ref").addEventListener("contextmenu",zoteroRoam.interface.popContextMenu)}},checkReferences(e=!1){var t;setTimeout(function(){do{var e=document.getElementsByClassName("rm-page-ref");t=zoteroRoam.inPage.identifyCitekeys(e)}while(1==t)},300),zoteroRoam.inPage.checkCitekeys(e),zoteroRoam.inPage.addContextMenuListener()},identifyCitekeys(t){let o=!1;for(i=0;i<t.length;i++){let e=t[i].parentElement;void 0!==e.dataset.linkTitle&&e.dataset.linkTitle.startsWith("@")&&(o=!e.classList.contains("ref-citekey")&&(e.classList.add("ref-citekey"),!0))}return o},checkCitekeys(e=!1){let t=document.querySelectorAll(".ref-citekey"),o=0,a=0;t.forEach(t=>{if(t.dataset.zoteroBib)1==e&&"notFound"==t.dataset.zoteroBib&&(zoteroRoam.data.items.find(e=>e.key==t.dataset.linkTitle.replace("@",""))?(t.dataset.zoteroBib="inLibrary",o+=1):a+=1);else switch(t.dataset.zoteroBib=zoteroRoam.data.items.find(e=>e.key==t.dataset.linkTitle.replace("@",""))?"inLibrary":"notFound",t.dataset.zoteroBib){case"inLibrary":o+=1;break;case"notFound":a+=1}}),0<o|0<a&&console.log(`New matched citekeys: ${o}, New unmatched citekeys: ${a}`)},convertToCitekey(t){var r=zoteroRoam.data.items.find(e=>e.key==t.innerText.slice(1));let e=t.closest(".roam-block");var o=e.id.slice(-9),a=Array.from(e.querySelectorAll(".ref-citekey")).findIndex(e=>e==t.parentNode),i=window.roamAlphaAPI.q("[:find ?text :in $ ?uid :where[?b :block/uid ?uid][?b :block/string ?text]]",o)[0];if(0<i.length){let e=i[0];a=new RegExp(`(.*?(?:\\[\\[@.+?\\]\\].*?){${a}})(\\[\\[@.+?\\]\\])(.*)`,"g"),a=e.replace(a,(e,t,o,a)=>`${t}${zoteroRoam.utils.formatItemReference(r,"citation")}${a}`);window.roamAlphaAPI.updateBlock({block:{uid:o,string:a}})}},async addPageMenus(){for(const d of Array.from(document.querySelectorAll("h1.rm-title-display"))){let i=d.querySelector("span")?d.querySelector("span").innerText:"";if(i.startsWith("@")){var o=zoteroRoam.data.items.find(e=>e.key==i.slice(1));if(void 0!==o){var n=o.data.DOI?zoteroRoam.utils.parseDOI(o.data.DOI):"";if(null==d.parentElement.querySelector(".zotero-roam-page-div")){let e=document.createElement("div");e.classList.add("zotero-roam-page-div"),d.parentElement.appendChild(e)}if(null==d.parentElement.querySelector(".zotero-roam-page-menu")){let a=document.createElement("div");a.classList.add("zotero-roam-page-menu"),a.classList.add("bp3-button-group"),d.parentElement.querySelector(".zotero-roam-page-div").appendChild(a);let e=zoteroRoam.formatting.getItemChildren(o,{pdf_as:"raw",notes_as:"raw"});var s=e.notes?zoteroRoam.utils.renderBP3Button_group(string="Import notes",{buttonClass:"bp3-minimal zotero-roam-page-menu-import-notes",icon:"comment"}):"",l=e.pdfItems?e.pdfItems.map(e=>{e=`<a href="${["linked_file","imported_file","imported_url"].includes(e.data.linkMode)?`zotero://open-pdf/library/items/${e.data.key}`:e.data.url}">${e.data.filename||e.data.title}</a>`;return zoteroRoam.utils.renderBP3Button_group(string=e,{buttonClass:"bp3-minimal zotero-roam-page-menu-pdf-link",icon:"paperclip"})}).join(""):"";let t=[zoteroRoam.utils.renderBP3Button_group(string=`<a href="https://www.connectedpapers.com/${o.data.DOI?"api/redirect/doi/"+n:"search?q="+encodeURIComponent(o.data.title)}" target="_blank">Connected Papers</a>`,{buttonClass:"bp3-minimal zotero-roam-page-menu-connected-papers",icon:"layout"}),o.data.DOI?zoteroRoam.utils.renderBP3Button_group(string=`<a href="https://api.semanticscholar.org/${n}" target="_blank">Semantic Scholar</a>`,{buttonClass:"bp3-minimal zotero-roam-page-menu-semantic-scholar",icon:"bookmark"}):"",zoteroRoam.utils.renderBP3Button_group(string=`<a href="https://scholar.google.com/scholar?q=${o.data.DOI?n:encodeURIComponent(o.data.title)}" target="_blank">Google Scholar</a>`,{buttonClass:"bp3-minimal zotero-roam-page-menu-google-scholar",icon:"learning"})],r="";if(o.data.DOI){let e=await zoteroRoam.handlers.requestScitations(n),o=e.citations.map(e=>e.doi);if(0<o.length){let e=zoteroRoam.data.items.filter(e=>e.data.DOI),t=e.filter(e=>o.includes(zoteroRoam.utils.parseDOI(e.data.DOI)));r=zoteroRoam.utils.renderBP3Button_group(string=`${0<t.length?t.length:"No"} citations in library`,{buttonClass:"bp3-minimal bp3-intent-success zotero-roam-page-menu-backlinks-button",icon:"caret-down bp3-icon-standard rm-caret rm-caret-closed"}),r+=zoteroRoam.utils.renderBP3Button_group(string=`${o.length} citations available`,{buttonClass:"bp3-minimal bp3-intent-warning zotero-roam-page-menu-backlinks-total",icon:"citation",buttonAttribute:`data-doi=${n}`}),0<t.length&&(r+=`
                                        <ul class="zotero-roam-page-menu-backlinks-list" style="display:none;">
                                        ${t.map(e=>{var t=zoteroRoam.utils.lookForPage("@"+e.key);return!0!==t.present?`
                                                    <li class="zotero-roam-page-menu-backlinks-item">
                                                    ${zoteroRoam.utils.renderBP3Button_group(string="",{buttonClass:"bp3-minimal zotero-roam-page-menu-backlink-add-sidebar",icon:"add-column-right",buttonAttribute:`data-title=@${e.key}`})}
                                                    ${zoteroRoam.utils.formatItemReference(e,"zettlr_accent")}
                                                    </li>`:`
                                                    <li class="zotero-roam-page-menu-backlinks-item">
                                                    ${zoteroRoam.utils.renderBP3Button_group(string="",{buttonClass:"bp3-minimal zotero-roam-page-menu-backlink-open-sidebar",icon:"two-columns",buttonAttribute:`data-uid=${t.uid}`})}
                                                    <a href="https://roamresearch.com/${window.location.hash.match(/#\/app\/([^\/]+)/g)[0]}/page/${t.uid}">${zoteroRoam.utils.formatItemReference(e,"zettlr_accent")}</a>
                                                    </li>`}).join("")}
                                        </ul>
                                        `)}}a.innerHTML=`
                            ${zoteroRoam.utils.renderBP3Button_group(string="Add metadata",{buttonClass:"bp3-minimal zotero-roam-page-menu-add-metadata",icon:"add"})}
                            ${s}
                            ${l}
                            ${t.join("")}
                            <hr>
                            ${r}
                            `,a.querySelector(".zotero-roam-page-menu-add-metadata").addEventListener("click",function(){var e=zoteroRoam.utils.lookForPage(i);console.log(`Importing metadata to ${i} (${e.uid})...`),zoteroRoam.handlers.addSearchResult(i,uid=e.uid,{popup:!0})});try{a.querySelector(".zotero-roam-page-menu-import-notes").addEventListener("click",function(){var e=zoteroRoam.utils.lookForPage(i);console.log(`Adding notes to ${i} (${e.uid})...`),zoteroRoam.handlers.addItemNotes(i,uid=e.uid)})}catch(e){}try{let o=a.querySelector(".zotero-roam-page-menu-backlinks-button");o.addEventListener("click",function(){let e=o.querySelector(".bp3-icon-caret-down"),t=o.parentElement.querySelector(".zotero-roam-page-menu-backlinks-list");Array.from(e.classList).includes("rm-caret-closed")&&t?(e.classList.replace("rm-caret-closed","rm-caret-open"),t.style.display="block"):Array.from(e.classList).includes("rm-caret-open")&&(e.classList.replace("rm-caret-open","rm-caret-closed"),t.style.display="none")});let e=a.querySelector(".zotero-roam-page-menu-backlinks-list");if(e){var c=Array.from(e.querySelectorAll(".zotero-roam-page-menu-backlink-open-sidebar"));if(0<c.length)for(const m of c)m.addEventListener("click",function(){zoteroRoam.utils.addToSidebar(uid=m.dataset.uid)});c=Array.from(e.querySelectorAll(".zotero-roam-page-menu-backlink-add-sidebar"));if(0<c.length)for(const u of c)u.addEventListener("click",async function(){var e=roamAlphaAPI.util.generateUID();roamAlphaAPI.createPage({page:{title:u.dataset.title,uid:e}}),await zoteroRoam.handlers.addSearchResult(i=u.dataset.title,uid=e,{popup:!1}),zoteroRoam.utils.addToSidebar(uid=e)})}}catch(e){}try{let t=a.querySelector(".zotero-roam-page-menu-backlinks-total");t.addEventListener("click",function(){var e=t.getAttribute("data-doi");zoteroRoam.interface.popCitationsOverlay(e)})}catch(e){}}o.data.DOI&&null==d.parentElement.querySelector(".scite-badge")&&(n=zoteroRoam.inPage.makeSciteBadge(doi=n),d.parentElement.querySelector(".zotero-roam-page-div").appendChild(n),window.__SCITE.insertBadges())}else try{d.parentElement.querySelector(".zotero-roam-page-div").remove()}catch(e){}}}},makeSciteBadge(e,{layout:t="horizontal",showZero:o="true",showLabels:a="false"}={}){let r=document.createElement("div");return r.classList.add("scite-badge"),r.setAttribute("data-doi",e),r.setAttribute("data-layout",t),r.setAttribute("data-show-zero",o),r.setAttribute("data-show-labels",a),r}},zoteroRoam.formatting={getCreators(e){return e.data.creators.map(e=>{let t=e.name?`[[${e.name}]]`:`[[${[e.firstName,e.lastName].filter(Boolean).join(" ")}]]`;return"author"!=e.creatorType&&(t=t+" ("+e.creatorType+")"),t}).join(", ")},async getItemBib(e,{include:t="bib",style:o="apa",linkwrap:a=0,locale:r="en-US"}={}){r=e.bib||await zoteroRoam.handlers.requestItemBib(e,{include:t,style:o,linkwrap:a,locale:r});return zoteroRoam.utils.formatBib(r)},getChildrenInDataset(t){var e=zoteroRoam.data.items.filter(e=>e.data.parentItem==t.data.key&e.library.id==t.library.id);return 0<e.length&&e},getItemChildren(t,{pdf_as:o="links",notes_as:e="formatted",split_char:a="\n"}={}){let r={pdfItems:!1,notes:!1},i=[];switch(0<t.meta.numChildren&&((t=zoteroRoam.formatting.getChildrenInDataset(t))?i=t:r.remoteChildren=!0),o){case"raw":var n=i.filter(e=>"application/pdf"==e.data.contentType);r.pdfItems=0!=n.length&&n;break;case"identity":let e=i.filter(e=>"application/pdf"==e.data.contentType);r.pdfItems=0!=e.length&&e.map(e=>({title:e.data.title,key:e.key,link:zoteroRoam.utils.makePDFLinks(e)}));break;case"links":r.pdfItems=zoteroRoam.utils.makePDFLinks(i.filter(e=>"application/pdf"==e.data.contentType))}switch(e){case"raw":var s=i.filter(e=>"note"==e.data.itemType);r.notes=0!=s.length&&s;break;case"formatted":r.notes=zoteroRoam.utils.formatItemNotes(i.filter(e=>"note"==e.data.itemType),{split_char:a})}return r},getItemCollections(o){return 0<o.data.collections.length&&o.data.collections.map(t=>zoteroRoam.data.collections.find(e=>e.key==t&&e.library.id==o.library.id))},getItemRelated(o,a="citekeys"){if(!o.data.relations)return[];{let e=[];for(rel of Object.values(o.data.relations))for(match of rel.matchAll(/http:\/\/zotero.org\/(.*)\/items\/(.+)/g))e.push({lib:match[1],key:match[2]});let t=e.map(t=>zoteroRoam.data.items.find(e=>e.data.key==t.key&&`${e.library.type}s/${e.library.id}`==t.lib)||!1).filter(Boolean);switch(a){case"raw":return t;case"citekeys":return t.map(e=>"[[@"+e.key+"]]")}}},getItemType(e){let t=zoteroRoam.typemap[e.data.itemType]||e.data.itemType;return zoteroRoam.config.userSettings.typemap&&(t=zoteroRoam.config.userSettings.typemap[e.data.itemType]||t),t},getLocalLink(e,{text:t="Local library"}={}){return`[${t}](zotero://select/library/items/${e.data.key})`},getWebLink(e,{text:t="Web library"}={}){e.library.type="user";return`[${t}](https://www.zotero.org/users/${e.library.id}/items/${e.data.key})`},getTags(e){return e.data.tags.map(e=>"#[["+e.tag+"]]").join(", ")},getItemMetadata(e){let t=[];e.data.title&&t.push(`Title:: ${e.data.title}`),0<e.data.creators.length&&t.push(`Author(s):: ${zoteroRoam.formatting.getCreators(e)}`),e.data.abstractNote&&t.push(`Abstract:: ${e.data.abstractNote}`),e.data.itemType&&t.push(`Type:: [[${zoteroRoam.formatting.getItemType(e)}]]`),t.push(`Publication:: ${e.data.publicationTitle||e.data.bookTitle||""}`),e.data.url&&t.push(`URL : ${e.data.url}`),e.data.dateAdded&&t.push(`Date Added:: ${zoteroRoam.utils.makeDNP(e.data.dateAdded,{brackets:!0})}`),t.push(`Zotero links:: ${zoteroRoam.formatting.getLocalLink(e)}, ${zoteroRoam.formatting.getWebLink(e)}`),0<e.data.tags.length&&t.push(`Tags:: ${zoteroRoam.formatting.getTags(e)}`);let o=zoteroRoam.formatting.getItemChildren(e,{pdf_as:"links",notes_as:"formatted",split_char:"\n"});if(o.pdfItems&&t.push(`PDF links : ${o.pdfItems.join(", ")}`),o.notes){let e={string:"[[Notes]]",children:[]};e.children.push(...o.notes.flat(1)),t.push(e)}return t}},zoteroRoam.shortcuts={actions:{closeSearchPanel:{defaultShortcut:{Escape:!0},execute(){var e=document.querySelector('.bp3-overlay[overlay-visible="true"]')||!1;e&&(Array.from(e.classList).includes(`${zoteroRoam.interface.search.overlayClass}-overlay`)?zoteroRoam.interface.toggleSearchOverlay("hide"):Array.from(e.classList).includes(`${zoteroRoam.interface.citations.overlayClass}-overlay`)&&zoteroRoam.interface.closeCitationsOverlay())}},toggleSearchPanel:{defaultShortcut:{altKey:!0,q:!0},execute(){var e;"true"==zoteroRoam.interface.citations.overlay.getAttribute("overlay-visible")?zoteroRoam.interface.closeCitationsOverlay():(e="true"==zoteroRoam.interface.search.overlay.getAttribute("overlay-visible")?"hide":"show",zoteroRoam.interface.toggleSearchOverlay(e))}},toggleQuickCopy:{defaultShortcut:[],execute(){document.getElementById("zotero-quick-copy-mode").click()}},importMetadata:{defaultShortcut:[],execute(){let e=document.querySelector("button.item-add-metadata");null!==e&&e.click()}},focusSearchBar:{defaultShortcut:[],execute(){let e=document.querySelector('.bp3-overlay[overlay-visible="true"]')||!1;e&&e.querySelector('input.bp3-input[type="text"]').focus()}},goToItemPage:{defaultShortcut:[],execute(){let e=document.querySelector("button.item-go-to-page");null!==e&&0==e.disabled&&e.querySelector("a").click()}},copyCitekey:{defaultShortcut:[],execute(){let e=document.querySelector('.item-citekey .copy-buttons a.bp3-button[format="citekey"]');null!==e&&e.click()}},copyCitation:{defaultShortcut:[],execute(){let e=document.querySelector('.item-citekey .copy-buttons a.bp3-button[format="citation"]');null!==e&&e.click()}},copyTag:{defaultShortcut:[],execute(){let e=document.querySelector('.item-citekey .copy-buttons a.bp3-button[format="tag"]');null!==e&&e.click()}},copyPageRef:{defaultShortcut:[],execute(){let e=document.querySelector('.item-citekey .copy-buttons a.bp3-button[format="page-reference"]');null!==e&&e.click()}}},sequences:{},getSequences(t){let o=zoteroRoam.config.shortcuts.filter(e=>e.action==t);if(0==o.length)return!1;{let e=o.map(e=>{let t=[];for(key in e.template){var o;1==e.template[key]&&(o=key.endsWith("Key")?key.slice(0,-3):key,t.push(o))}return t});return e.map(e=>e.join("-")).join(" or ")}},generateSequences(){for(action in zoteroRoam.shortcuts.actions){var e=zoteroRoam.shortcuts.getSequences(action);e&&(zoteroRoam.shortcuts.sequences[action]=e)}},makeSequenceText(e,t="",o){return`${t}<span class="zotero-roam-sequence">${zoteroRoam.shortcuts.sequences[e]}</span>`},setup(){let o={};Object.keys(zoteroRoam.shortcuts.actions).forEach(e=>{o[e]=zoteroRoam.shortcuts.actions[e].defaultShortcut});let a={};zoteroRoam.config.userSettings.shortcuts?Object.keys(zoteroRoam.shortcuts.actions).forEach(e=>{var{[e]:t=o[e]}=zoteroRoam.config.userSettings.shortcuts;a[e]=t}):a=o;let t=[];for(k in a)a[k].constructor===Object?t.push({action:k,template:a[k]}):a[k].constructor===Array&&a[k].forEach(e=>{t.push({action:k,template:e})});t.forEach(e=>{zoteroRoam.config.shortcuts.push(new zoteroRoam.Shortcut(e))})},setupSequences(){zoteroRoam.shortcuts.generateSequences();let o=zoteroRoam.shortcuts.sequences.toggleSearchPanel?zoteroRoam.shortcuts.makeSequenceText("toggleSearchPanel",pre="Toggle search panel with "):"",a=zoteroRoam.shortcuts.sequences.closeSearchPanel?zoteroRoam.shortcuts.makeSequenceText("closeSearchPanel",pre="Exit with "):"";if(0<o.length|0<a.length){let e=document.createElement("span");e.style="font-style:italic;",e.innerHTML=`${[o,a].filter(Boolean).join(" / ")}  `;let t=zoteroRoam.interface.search.overlay.querySelector(".bp3-dialog-header");if(t.insertBefore(e,zoteroRoam.interface.search.closeButton),0<a.length){let e=zoteroRoam.interface.citations.overlay.querySelector(".bp3-dialog-header"),t=document.createElement("span");t.style="font-style:italic;",t.innerHTML=`${a}`,e.insertBefore(t,zoteroRoam.interface.citations.closeButton)}}var r=zoteroRoam.shortcuts.sequences.toggleQuickCopy?zoteroRoam.shortcuts.makeSequenceText("toggleQuickCopy",pre=" "):"";if(0<r.length){let e=document.querySelector(".zotero-search-overlay .bp3-dialog-header");e.querySelector(".bp3-control.bp3-switch").innerHTML+=r}r=zoteroRoam.shortcuts.sequences.focusSearchBar?zoteroRoam.shortcuts.makeSequenceText("focusSearchBar"):"";if(0<r.length){let t=document.createElement("span");t.classList.add("bp3-input-action"),t.style="height:30px;padding:5px;",t.innerHTML=`${r}`,Array.from(document.querySelectorAll(`#${zoteroRoam.interface.portal.id} input.bp3-input[type="text"]`)).forEach(e=>e.closest(".bp3-input-group").appendChild(t.cloneNode(!0)))}},verify(r){let i=r.key;var n="keydown"==r.type;let s=["altKey","ctrlKey","metaKey","shiftKey"];zoteroRoam.config.shortcuts=zoteroRoam.config.shortcuts.map(e=>{let{action:t,template:o,watcher:a}=e;return s.forEach(e=>{a[e]=r[e]}),o.hasOwnProperty(i)|o.hasOwnProperty(i.toLowerCase())&&(e=o.hasOwnProperty(i)?i:i.toLowerCase(),a[e]=n),{action:t,template:o,watcher:a}}),zoteroRoam.config.shortcuts.forEach(e=>{JSON.stringify(e.watcher)===JSON.stringify(e.template)&&zoteroRoam.shortcuts.actions[`${e.action}`].execute()})}};export{zoteroRoam as zoteroRoam};